<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>尼玛豹哥</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="尼玛豹哥">
<meta property="og:url" content="http://blog.yangxc.com/page/4/index.html">
<meta property="og:site_name" content="尼玛豹哥">
<meta property="og:locale">
<meta property="article:author" content="YangXC">
<meta name="twitter:card" content="summary">
  
    <link rel="alternative" href="/atom.xml" title="尼玛豹哥" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.ico">
  
  <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
<link rel="stylesheet" href="/css/style.css">

  

<meta name="generator" content="Hexo 5.3.0"></head>
<body>
  <div id="container">
    <div id="wrap">
      <div id="blog-header">
  <img src="/images/avatar.jpg">
  <div id="blog-title">尼玛豹哥</div>
</div>
<hr id="header-line">

      <div class="outer">
        <section id="main">
  
    <article id="post-chromium-startup" class="article article-type-post" itemscope itemprop="blogPost">
  
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/04/01/chromium-startup/">Chromium学习笔记：程序启动入口分析（Windows）</a>
    </h1>
  

      </header>
    
    <div class="article-meta">
      <a href="/2019/04/01/chromium-startup/" class="article-date">
  <time datetime="2019-04-01T06:34:31.000Z" itemprop="datePublished">2019-04-01</time>
</a>
      
    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <p>以下笔记内容均为Windows版本。</p>
<p>本篇笔记跟踪记录了Chromium的启动过程，主要关注 <code>Browser</code> 进程和 <code>Renderer</code> 进程。根据 <code>Chromium</code> 项目的分层设计，我们把 <code>Content API</code> 称作为 <code>Content</code> 层，而把调用 <code>Content API</code> 实现浏览器程序的部分称作为 <code>Embedder</code> 层。在项目中，<code>Embedder</code> 层有 <code>chrome</code>、<code>content_shell</code> 等多种实现。</p>
<h2 id="1、main-函数"><a href="#1、main-函数" class="headerlink" title="1、main() 函数"></a>1、main() 函数</h2><p>Chromium的main函数在 <code>chrome\app\chrome_exe_main_win.cc</code>，具体如下：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// chrome\app\chrome_exe_main_win.cc</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> !defined(WIN_CONSOLE_APP)</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> APIENTRY <span class="title">wWinMain</span><span class="params">(HINSTANCE instance, HINSTANCE prev, <span class="keyword">wchar_t</span>*, <span class="keyword">int</span>)</span> </span>&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  HINSTANCE instance = GetModuleHandle(<span class="literal">nullptr</span>);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">  install_static::InitializeFromPrimaryModule();</span><br><span class="line">  SignalInitializeCrashReporting();</span><br><span class="line"></span><br><span class="line">  ......</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Load and launch the chrome dll. *Everything* happens inside.</span></span><br><span class="line">  VLOG(<span class="number">1</span>) &lt;&lt; <span class="string">&quot;About to load main DLL.&quot;</span>;</span><br><span class="line">  MainDllLoader* loader = MakeMainDllLoader();</span><br><span class="line">  <span class="keyword">int</span> rc = loader-&gt;Launch(instance, exe_entry_point_ticks);</span><br><span class="line">  loader-&gt;RelaunchChromeBrowserWithNewCommandLineIfNeeded();</span><br><span class="line">  <span class="keyword">delete</span> loader;</span><br><span class="line">  <span class="keyword">return</span> rc;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在main函数中，最重要的一步，就是 <code>int rc = loader-&gt;Launch(instance, exe_entry_point_ticks);</code> 载入 <code>chrome.dll运行</code>。</p>
<h2 id="2、载入-chrome-dll"><a href="#2、载入-chrome-dll" class="headerlink" title="2、载入 chrome.dll"></a>2、载入 chrome.dll</h2><p>在这里首先调用了 <code>MakeMainDllLoader()</code> 函数，这是一个静态函数，在<code>chrome\app\main_dll_loader.cc</code> 中，内容如下：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// chrome\app\main_dll_loader.cc</span></span><br><span class="line"></span><br><span class="line"><span class="function">MainDllLoader* <span class="title">MakeMainDllLoader</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(GOOGLE_CHROME_BUILD)</span></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> ChromeDllLoader();</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> ChromiumDllLoader();</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>函数创建并返回一个 <code>ChromiumDllLoader</code>，紧接着再调用它的 <code>Launch</code> 函数，内容如下：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// chrome\app\main_dll_loader.cc</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">MainDllLoader::Launch</span><span class="params">(HINSTANCE instance,</span></span></span><br><span class="line"><span class="function"><span class="params">                          base::TimeTicks exe_entry_point_ticks)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> base::CommandLine&amp; cmd_line = *base::CommandLine::ForCurrentProcess();</span><br><span class="line">  process_type_ = cmd_line.GetSwitchValueASCII(switches::kProcessType);</span><br><span class="line"></span><br><span class="line">  ......</span><br><span class="line"></span><br><span class="line">  dll_ = Load(&amp;file);</span><br><span class="line">  <span class="keyword">if</span> (!dll_)</span><br><span class="line">    <span class="keyword">return</span> chrome::RESULT_CODE_MISSING_DATA;</span><br><span class="line"></span><br><span class="line">  OnBeforeLaunch(cmd_line, process_type_, file);</span><br><span class="line">  DLL_MAIN chrome_main =</span><br><span class="line">      <span class="keyword">reinterpret_cast</span>&lt;DLL_MAIN&gt;(::GetProcAddress(dll_, <span class="string">&quot;ChromeMain&quot;</span>));</span><br><span class="line">  <span class="keyword">int</span> rc = chrome_main(instance, &amp;sandbox_info,</span><br><span class="line">                       exe_entry_point_ticks.ToInternalValue());</span><br><span class="line">  OnBeforeExit(file);</span><br><span class="line">  <span class="keyword">return</span> rc;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里完成了 <code>chrome.dll</code> 的载入，并且执行里面的 <code>ChromeMain</code> 函数。</p>
<h2 id="3、ChromeMain-函数"><a href="#3、ChromeMain-函数" class="headerlink" title="3、ChromeMain() 函数"></a>3、ChromeMain() 函数</h2><p><code>ChromeMain</code> 函数负责 <code>Embedder</code> 层的实现类创建，并传递给 <code>Content</code> 层，定义在 <code>chrome\app\chrome_main.cc</code> 中，内容如下：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// chrome\app\chrome_main.cc</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> &#123;</span><br><span class="line"><span class="function">DLLEXPORT <span class="keyword">int</span> __cdecl <span class="title">ChromeMain</span><span class="params">(HINSTANCE instance,</span></span></span><br><span class="line"><span class="function"><span class="params">                                 sandbox::SandboxInterfaceInfo* sandbox_info,</span></span></span><br><span class="line"><span class="function"><span class="params">                                 <span class="keyword">int64_t</span> exe_entry_point_ticks)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">......</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(OS_WIN)</span></span><br><span class="line"><span class="function">DLLEXPORT <span class="keyword">int</span> __cdecl <span class="title">ChromeMain</span><span class="params">(HINSTANCE instance,</span></span></span><br><span class="line"><span class="function"><span class="params">                                 sandbox::SandboxInterfaceInfo* sandbox_info,</span></span></span><br><span class="line"><span class="function"><span class="params">                                 <span class="keyword">int64_t</span> exe_entry_point_ticks)</span> </span>&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">elif</span> defined(OS_POSIX)</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">ChromeMain</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span>** argv)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">int64_t</span> exe_entry_point_ticks = <span class="number">0</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(OS_WIN)</span></span><br><span class="line">  install_static::InitializeFromPrimaryModule();</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">  <span class="function">ChromeMainDelegate <span class="title">chrome_main_delegate</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">      base::TimeTicks::FromInternalValue(exe_entry_point_ticks))</span></span>;</span><br><span class="line">  <span class="function">content::ContentMainParams <span class="title">params</span><span class="params">(&amp;chrome_main_delegate)</span></span>;</span><br><span class="line"></span><br><span class="line">  ......</span><br><span class="line"></span><br><span class="line">  <span class="keyword">int</span> rv = content::ContentMain(params);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> rv;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>在ChromeMain中，最终执行到了 <code>content::ContentMain</code> 这个函数。</p>
<h2 id="4、content-ContentMain-函数"><a href="#4、content-ContentMain-函数" class="headerlink" title="4、content::ContentMain() 函数"></a>4、content::ContentMain() 函数</h2><p>代码执行到这里，进入了 <code>Content</code> 层，并且传入参数 <code>content::ContentMainParams</code> 类型的参数 <code>params</code>，它是由 <code>Embedder</code> 层传递过来的重要参数，里面包含了 <code>Embedder</code> 层的具体实现信息，此结构体在 <code>content\public\app\content_main.h</code> 中定义如下：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// content\public\app\content_main.h</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ContentMainParams</span> &#123;</span></span><br><span class="line">  <span class="function"><span class="keyword">explicit</span> <span class="title">ContentMainParams</span><span class="params">(ContentMainDelegate* delegate)</span></span></span><br><span class="line"><span class="function">      : <span class="title">delegate</span><span class="params">(delegate)</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">  ContentMainDelegate* delegate;</span><br><span class="line"></span><br><span class="line">  ......</span><br></pre></td></tr></table></figure>
<p>其中有一个重要的成员变量 <code>delegate</code>，其类型为 <code>content::ContentMainDelegate</code>，它在 <code>content\public\app\content_main_delegate.cc</code> 中定义如下：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// content\public\app\content_main_delegate.cc</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CONTENT_EXPORT</span> <span class="title">ContentMainDelegate</span> &#123;</span></span><br><span class="line"> <span class="keyword">public</span>:</span><br><span class="line">  <span class="keyword">virtual</span> ~ContentMainDelegate() &#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="keyword">bool</span> <span class="title">BasicStartupComplete</span><span class="params">(<span class="keyword">int</span>* exit_code)</span></span>;</span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">PreSandboxStartup</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">SandboxInitialized</span><span class="params">(<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span>&amp; process_type)</span> </span>&#123;&#125;</span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="keyword">int</span> <span class="title">RunProcess</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">      <span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span>&amp; process_type,</span></span></span><br><span class="line"><span class="function"><span class="params">      <span class="keyword">const</span> MainFunctionParams&amp; main_function_params)</span></span>;</span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">ProcessExiting</span><span class="params">(<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span>&amp; process_type)</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">  ......</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">PreCreateMainMessageLoop</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">  ......</span><br><span class="line"></span><br><span class="line"> <span class="keyword">protected</span>:</span><br><span class="line">  <span class="keyword">friend</span> <span class="class"><span class="keyword">class</span> <span class="title">ContentClientInitializer</span>;</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> ContentBrowserClient* <span class="title">CreateContentBrowserClient</span><span class="params">()</span></span>;</span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> ContentGpuClient* <span class="title">CreateContentGpuClient</span><span class="params">()</span></span>;</span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> ContentRendererClient* <span class="title">CreateContentRendererClient</span><span class="params">()</span></span>;</span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> ContentUtilityClient* <span class="title">CreateContentUtilityClient</span><span class="params">()</span></span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>可以看到，这里定义了一系列与启动相关的操作，并且通过几个 <code>CreateXXX</code> 的函数，获取 <code>ContentBrowserClient</code>、<code>ContentRendererClient</code> 等接口具体的实现，这也是 <code>content API</code> 的巧妙设计，通过这种方式，将浏览器的实现放入了 <code>content</code> 中。</p>
<p>继续往下看，<code>content::ContentMain()</code> 中调用了 <code>content\app\content_main.cc</code> 中的 <code>service_manager::Main()</code>：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// content\app\content_main.cc</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">ContentMain</span><span class="params">(<span class="keyword">const</span> ContentMainParams&amp; params)</span> </span>&#123;</span><br><span class="line">  <span class="function">ContentServiceManagerMainDelegate <span class="title">delegate</span><span class="params">(params)</span></span>;</span><br><span class="line">  <span class="function">service_manager::MainParams <span class="title">main_params</span><span class="params">(&amp;delegate)</span></span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> !defined(OS_WIN) &amp;&amp; !defined(OS_ANDROID)</span></span><br><span class="line">  main_params.argc = params.argc;</span><br><span class="line">  main_params.argv = params.argv;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">  <span class="keyword">return</span> service_manager::Main(main_params);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在这里，使用一个 <code>content::ContentServiceManagerMainDelegate</code> 对象来构建了 <code>main_params</code>，并传入了 <code>service_manager::Main()</code>。</p>
<h2 id="5、service-manager-Main-函数"><a href="#5、service-manager-Main-函数" class="headerlink" title="5、service_manager::Main 函数"></a>5、service_manager::Main 函数</h2><p><code>service_manager::Main</code> 函数位于 <code>services\service_manager\embedder\main.cc</code>，接收一个 <code>MainParams</code> 类型的参数，具体如下：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// services\service_manager\embedder\main.cc</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">Main</span><span class="params">(<span class="keyword">const</span> MainParams&amp; params)</span> </span>&#123;</span><br><span class="line">  MainDelegate* delegate = params.delegate;</span><br><span class="line"></span><br><span class="line">  ......</span><br><span class="line"></span><br><span class="line">  ProcessType process_type = delegate-&gt;OverrideProcessType();</span><br><span class="line"></span><br><span class="line">  ......</span><br><span class="line">  <span class="comment">// A flag to indicate whether Main() has been called before. On Android, we</span></span><br><span class="line">  <span class="comment">// may re-run Main() without restarting the browser process. This flag</span></span><br><span class="line">  <span class="comment">// prevents initializing things more than once.</span></span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">bool</span> is_initialized = <span class="literal">false</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> !defined(OS_ANDROID)</span></span><br><span class="line">  DCHECK(!is_initialized);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">  <span class="keyword">if</span> (!is_initialized) &#123;</span><br><span class="line">    is_initialized = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">  ......</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(OS_WIN)</span></span><br><span class="line">    base::win::RegisterInvalidParamHandler();</span><br><span class="line">    ui::win::CreateATLModuleIfNeeded();</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span>  <span class="comment">// defined(OS_WIN)</span></span></span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">    base::CommandLine::Init(argc, argv);</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">auto</span>&amp; command_line = *base::CommandLine::ForCurrentProcess();</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(OS_WIN)</span></span><br><span class="line">    base::win::SetupCRT(command_line);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    MainDelegate::InitializeParams init_params;</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line">    mojo::core::Init(mojo_config);</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">    exit_code = delegate-&gt;Initialize(init_params);</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">auto</span>&amp; command_line = *base::CommandLine::ForCurrentProcess();</span><br><span class="line">  <span class="keyword">if</span> (process_type == ProcessType::kDefault) &#123;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">string</span> type_switch =</span><br><span class="line">        command_line.GetSwitchValueASCII(switches::kProcessType);</span><br><span class="line">    <span class="keyword">if</span> (type_switch == switches::kProcessTypeServiceManager) &#123;</span><br><span class="line">      process_type = ProcessType::kServiceManager;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (type_switch == switches::kProcessTypeService) &#123;</span><br><span class="line">      process_type = ProcessType::kService;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      process_type = ProcessType::kEmbedder;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">switch</span> (process_type) &#123;</span><br><span class="line">    <span class="keyword">case</span> ProcessType::kDefault:</span><br><span class="line">      NOTREACHED();</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> ProcessType::kServiceManager:</span><br><span class="line">      exit_code = RunServiceManager(delegate);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> ProcessType::kService:</span><br><span class="line">      CommonSubprocessInit();</span><br><span class="line">      exit_code = RunService(delegate);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> ProcessType::kEmbedder:</span><br><span class="line">      <span class="keyword">if</span> (delegate-&gt;IsEmbedderSubprocess())</span><br><span class="line">        CommonSubprocessInit();</span><br><span class="line">      exit_code = delegate-&gt;RunEmbedderProcess();</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  ......</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (process_type == ProcessType::kEmbedder)</span><br><span class="line">    delegate-&gt;ShutDownEmbedderProcess();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> exit_code;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里截取的代码比较长，也非常重要，我们主要关注这四个部分：</p>
<ul>
<li>根据传入的 <code>delegate</code> 和 <code>command_line</code> 决定进程的类型</li>
<li>运行环境的初始化，比如 <code>CreateATLModuleIfNeeded</code>，<code>SetupCRT</code> 并用 <code>is_initialized</code> 来防止重复执行</li>
<li>通过传入的 <code>delegate</code> 进行程序的初始化操作，<code>delegate-&gt;Initialize(init_params)</code></li>
<li>根据进程类型启动相应的工作</li>
</ul>
<p>这里的 <code>delegate</code> 类型为 <code>service_manager::MainDelegate*</code>，是在 <code>services/service_manager/embedder/main_delegate.h</code> 中定义的抽象类，在这里我们主要关注它的 <code>Initialize</code>、<code>RunEmbedderProcess</code> 和 <code>ShutDownEmbedderProcess</code>，其中 <code>Initialize</code> 为被声明为纯虚函数，<code>RunEmbedderProcess</code> 和 <code>ShutDownEmbedderProcess</code> 又是什么都不做的，代码如下：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// services/service_manager/embedder/main_delegate.h</span></span><br><span class="line"></span><br><span class="line"><span class="function">class <span class="title">COMPONENT_EXPORT</span><span class="params">(SERVICE_MANAGER_EMBEDDER)</span> MainDelegate </span>&#123;</span><br><span class="line"> <span class="keyword">public</span>:</span><br><span class="line">  <span class="comment">// Perform early process initialization. Returns -1 if successful, or the exit</span></span><br><span class="line">  <span class="comment">// code with which the process should be terminated due to initialization</span></span><br><span class="line">  <span class="comment">// failure.</span></span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="keyword">int</span> <span class="title">Initialize</span><span class="params">(<span class="keyword">const</span> InitializeParams&amp; params)</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  ......</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Runs the embedder&#x27;s own main process logic. Called exactly once after a</span></span><br><span class="line">  <span class="comment">// successful call to Initialize(), and only if the Service Manager core does</span></span><br><span class="line">  <span class="comment">// not know what to do otherwise -- i.e., if it is not starting a new Service</span></span><br><span class="line">  <span class="comment">// Manager instance or launching an embedded service.</span></span><br><span class="line">  <span class="comment">//</span></span><br><span class="line">  <span class="comment">// Returns the exit code to use when terminating the process after</span></span><br><span class="line">  <span class="comment">// RunEmbedderProcess() (and then ShutDown()) completes.</span></span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="keyword">int</span> <span class="title">RunEmbedderProcess</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">  ......</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Called just before process exit if RunEmbedderProcess() was called.</span></span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">ShutDownEmbedderProcess</span><span class="params">()</span></span>;</span><br></pre></td></tr></table></figure>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// services/service_manager/embedder/main_delegate.cc</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">MainDelegate::RunEmbedderProcess</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">MainDelegate::ShutDownEmbedderProcess</span><span class="params">()</span> </span>&#123;&#125;</span><br></pre></td></tr></table></figure>
<p>回到 <code>service_manager::Main()</code>，我们看到第一句 <code>MainDelegate* delegate = params.delegate;</code> 中的 <code>params.delegate</code> 就是前面在 <code>content::ContentMain</code> 中构建 <code>main_params</code> 所使用的 <code>content::ContentServiceManagerMainDelegate</code> 对象，因此，上述的三个函数 <code>Initialize</code>、<code>RunEmbedderProcess</code>、<code>ShutDownEmbedderProcess</code> 是由 <code>ContentServiceManagerMainDelegate</code> 来最终实现的，来看代码：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// content\app\content_service_manager_main_delegate.cc</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">ContentServiceManagerMainDelegate::Initialize</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">const</span> InitializeParams&amp; params)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  ......</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> content_main_runner_-&gt;Initialize(content_main_params_);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">......</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">ContentServiceManagerMainDelegate::RunEmbedderProcess</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> content_main_runner_-&gt;Run(start_service_manager_only_);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">......</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ContentServiceManagerMainDelegate::ShutDownEmbedderProcess</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> !defined(OS_ANDROID)</span></span><br><span class="line">  content_main_runner_-&gt;Shutdown();</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在这三个函数的定义中，都使用了 <code>content_main_runner_</code> 这个成员变量来具体执行，它的定义为 <code>std::unique_ptr&lt;ContentMainRunnerImpl&gt;</code>。</p>
<h2 id="6、整个程序的Runner，content-ContentMainRunnerImpl"><a href="#6、整个程序的Runner，content-ContentMainRunnerImpl" class="headerlink" title="6、整个程序的Runner，content::ContentMainRunnerImpl"></a>6、整个程序的Runner，content::ContentMainRunnerImpl</h2><p>这个 <code>content::ContentMainRunnerImpl</code> 是 <code>content::ContentMainRunner</code> 接口的一个实现，先来看接口的声明：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// content\app\content_main_runner_impl.h</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CONTENT_EXPORT</span> <span class="title">ContentMainRunner</span> &#123;</span></span><br><span class="line"> <span class="keyword">public</span>:</span><br><span class="line">  <span class="keyword">virtual</span> ~ContentMainRunner() &#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Create a new ContentMainRunner object.</span></span><br><span class="line">  <span class="function"><span class="keyword">static</span> ContentMainRunner* <span class="title">Create</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Initialize all necessary content state.</span></span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="keyword">int</span> <span class="title">Initialize</span><span class="params">(<span class="keyword">const</span> ContentMainParams&amp; params)</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Perform the default run logic.</span></span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="keyword">int</span> <span class="title">Run</span><span class="params">(<span class="keyword">bool</span> start_service_manager_only)</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Shut down the content state.</span></span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">Shutdown</span><span class="params">()</span> </span>= <span class="number">0</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>再来看实现类的代码：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// content\app\content_main_runner_impl.h</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ContentMainRunnerImpl</span> :</span> <span class="keyword">public</span> ContentMainRunner &#123;</span><br><span class="line"> <span class="keyword">public</span>:</span><br><span class="line">  <span class="function"><span class="keyword">static</span> ContentMainRunnerImpl* <span class="title">Create</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">  ContentMainRunnerImpl();</span><br><span class="line">  ~ContentMainRunnerImpl() <span class="keyword">override</span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">int</span> <span class="title">TerminateForFatalInitializationError</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ContentMainRunner:</span></span><br><span class="line">  <span class="function"><span class="keyword">int</span> <span class="title">Initialize</span><span class="params">(<span class="keyword">const</span> ContentMainParams&amp; params)</span> <span class="keyword">override</span></span>;</span><br><span class="line">  <span class="function"><span class="keyword">int</span> <span class="title">Run</span><span class="params">(<span class="keyword">bool</span> start_service_manager_only)</span> <span class="keyword">override</span></span>;</span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">Shutdown</span><span class="params">()</span> <span class="keyword">override</span></span>;</span><br><span class="line"></span><br><span class="line">  ......</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="7、ContentMainRunner-Initialize-函数"><a href="#7、ContentMainRunner-Initialize-函数" class="headerlink" title="7、ContentMainRunner::Initialize() 函数"></a>7、ContentMainRunner::Initialize() 函数</h2><p>先来看 <code>Initialize</code> 函数：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// content\app\content_main_runner_impl.cc</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">ContentMainRunnerImpl::Initialize</span><span class="params">(<span class="keyword">const</span> ContentMainParams&amp; params)</span> </span>&#123;</span><br><span class="line">  ui_task_ = params.ui_task;</span><br><span class="line">  created_main_parts_closure_ = params.created_main_parts_closure;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(OS_WIN)</span></span><br><span class="line">  sandbox_info_ = *params.sandbox_info;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span>  <span class="comment">// !OS_WIN</span></span></span><br><span class="line"></span><br><span class="line">  ......</span><br><span class="line"></span><br><span class="line">  is_initialized_ = <span class="literal">true</span>;</span><br><span class="line">  delegate_ = params.delegate;</span><br><span class="line"></span><br><span class="line">  ......</span><br><span class="line"></span><br><span class="line">  <span class="keyword">int</span> exit_code = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> (delegate_-&gt;BasicStartupComplete(&amp;exit_code))</span><br><span class="line">    <span class="keyword">return</span> exit_code;</span><br><span class="line">  completed_basic_startup_ = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">  ......</span><br><span class="line"></span><br><span class="line">    delegate_-&gt;PreSandboxStartup();</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(OS_WIN)</span></span><br><span class="line">    <span class="keyword">if</span> (!InitializeSandbox(</span><br><span class="line">            service_manager::SandboxTypeFromCommandLine(command_line),</span><br><span class="line">            params.sandbox_info))</span><br><span class="line">      <span class="keyword">return</span> TerminateForFatalInitializationError();</span><br><span class="line"><span class="meta">#<span class="meta-keyword">elif</span> defined(OS_MACOSX)</span></span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    delegate_-&gt;SandboxInitialized(process_type);</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Return -1 to indicate no early termination.</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>大致看一下，在这个 <code>Initialize</code> 中，主要是根据 <code>command_line</code> 启动了相应的 <code>sandbox service</code>，并在启动前后都触发了 <code>delegate_-&gt;PreSandboxStartup()</code> 和 <code>delegate_-&gt;SandboxInitialized(process_type)</code>，这个 <code>delegate_</code> 来自于传入的 <code>content::ContentMainParams</code> 结构体，这个结构体是在 <code>chrome_main.cc</code> 中调用 <code>content::ContentMain(params)</code> 时所创建，所以这个 <code>delegate_</code> 正是前面所提到的巧妙设计中，继承自 <code>content::ContentMainDelegate</code> 的 <code>ChromeMainDelegate</code> 对象，通过这一系列的调用，<code>content</code> 层就把创建 <code>sandbox service</code> 前后的事件触发了出来，具体实现者只要在 <code>ChromeMainDelegate</code> 中填充这两个时间点要做的事即可。</p>
<h2 id="8、进程入口，ContentMainRunner-Run-函数"><a href="#8、进程入口，ContentMainRunner-Run-函数" class="headerlink" title="8、进程入口，ContentMainRunner::Run() 函数"></a>8、进程入口，ContentMainRunner::Run() 函数</h2><p>再来看 <code>Run</code> 函数：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// // content\app\content_main_runner_impl.cc</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">ContentMainRunnerImpl::Run</span><span class="params">(<span class="keyword">bool</span> start_service_manager_only)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  ......</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> base::CommandLine&amp; command_line =</span><br><span class="line">      *base::CommandLine::ForCurrentProcess();</span><br><span class="line">  <span class="built_in">std</span>::<span class="built_in">string</span> process_type =</span><br><span class="line">      command_line.GetSwitchValueASCII(switches::kProcessType);</span><br><span class="line"></span><br><span class="line">  ......</span><br><span class="line"></span><br><span class="line">  <span class="function">MainFunctionParams <span class="title">main_params</span><span class="params">(command_line)</span></span>;</span><br><span class="line">  main_params.ui_task = ui_task_;</span><br><span class="line">  main_params.created_main_parts_closure = created_main_parts_closure_;</span><br><span class="line"></span><br><span class="line">  ......</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (process_type.empty())</span><br><span class="line">    <span class="keyword">return</span> RunServiceManager(main_params, start_service_manager_only);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> RunOtherNamedProcessTypeMain(process_type, main_params, delegate_);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>此处先判断 <code>process_type</code> 是否为空，为空则代表当前执行的是默认进程（一般情况下为 <code>Browser</code> 进程），则调用 <code>RunServiceManager()</code>，否则调用 <code>RunOtherNamedProcessTypeMain</code> 根据<code>process_type</code> 来执行相应的进程。先来看 <code>RunServiceManager</code>：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// content\app\content_main_runner_impl.cc</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">ContentMainRunnerImpl::RunServiceManager</span><span class="params">(MainFunctionParams&amp; main_params,</span></span></span><br><span class="line"><span class="function"><span class="params">                                             <span class="keyword">bool</span> start_service_manager_only)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  ......</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!service_manager_context_) &#123;</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">    delegate_-&gt;PreCreateMainMessageLoop();</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line">    </span><br><span class="line">    delegate_-&gt;PostEarlyInitialization(main_params.ui_task != <span class="literal">nullptr</span>);</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line">    </span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (should_start_service_manager_only)</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">  is_browser_main_loop_started_ = <span class="literal">true</span>;</span><br><span class="line">  startup_data_ = <span class="built_in">std</span>::make_unique&lt;StartupDataImpl&gt;();</span><br><span class="line">  startup_data_-&gt;thread = <span class="built_in">std</span>::move(service_manager_thread_);</span><br><span class="line">  startup_data_-&gt;service_manager_context = service_manager_context_.get();</span><br><span class="line">  main_params.startup_data = startup_data_.get();</span><br><span class="line">  <span class="keyword">return</span> RunBrowserProcessMain(main_params, delegate_);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>同样，这里通过 <code>delegate_</code> 做了一些操作之后，最后调用了 <code>RunBrowserProcessMain()</code> 函数，内容如下：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// content\app\content_main_runner_impl.cc</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">RunBrowserProcessMain</span><span class="params">(<span class="keyword">const</span> MainFunctionParams&amp; main_function_params,</span></span></span><br><span class="line"><span class="function"><span class="params">                          ContentMainDelegate* delegate)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">int</span> exit_code = delegate-&gt;RunProcess(<span class="string">&quot;&quot;</span>, main_function_params);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(OS_ANDROID)</span></span><br><span class="line">  <span class="comment">// In Android&#x27;s browser process, the negative exit code doesn&#x27;t mean the</span></span><br><span class="line">  <span class="comment">// default behavior should be used as the UI message loop is managed by</span></span><br><span class="line">  <span class="comment">// the Java and the browser process&#x27;s default behavior is always</span></span><br><span class="line">  <span class="comment">// overridden.</span></span><br><span class="line">  <span class="keyword">return</span> exit_code;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">  <span class="keyword">if</span> (exit_code &gt;= <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">return</span> exit_code;</span><br><span class="line">  <span class="keyword">return</span> BrowserMain(main_function_params);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>非常简单明了，首先通过 <code>delegate-&gt;RunProcess</code> 把执行默认进程的优先权交由 <code>Embedder</code> 层，如果 <code>Embedder</code> 层成功执行了进程并最终返回了成功标志（<code>exit_code &gt;= 0</code>），那么就退出函数；如果 <code>Embedder</code> 层对默认进程没有定义，就继续执行 <code>content::BrowserMain</code>，由此，<code>Browser</code> 进程开始执行。</p>
<p>再来看 <code>RunOtherNamedProcessTypeMain</code> 函数：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// content\app\content_main_runner_impl.cc</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">RunOtherNamedProcessTypeMain</span><span class="params">(<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span>&amp; process_type,</span></span></span><br><span class="line"><span class="function"><span class="params">                                 <span class="keyword">const</span> MainFunctionParams&amp; main_function_params,</span></span></span><br><span class="line"><span class="function"><span class="params">                                 ContentMainDelegate* delegate)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">const</span> MainFunction kMainFunctions[] = &#123;</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line">    </span><br><span class="line">    &#123;switches::kUtilityProcess, UtilityMain&#125;,</span><br><span class="line">    &#123;switches::kRendererProcess, RendererMain&#125;,</span><br><span class="line">    &#123;switches::kGpuProcess, GpuMain&#125;,</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; base::size(kMainFunctions); ++i) &#123;</span><br><span class="line">    <span class="keyword">if</span> (process_type == kMainFunctions[i].name) &#123;</span><br><span class="line">      <span class="keyword">int</span> exit_code = delegate-&gt;RunProcess(process_type, main_function_params);</span><br><span class="line">      <span class="keyword">if</span> (exit_code &gt;= <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> exit_code;</span><br><span class="line">      <span class="keyword">return</span> kMainFunctions[i].function(main_function_params);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  ......</span><br><span class="line"></span><br><span class="line">  <span class="comment">// If it&#x27;s a process we don&#x27;t know about, the embedder should know.</span></span><br><span class="line">  <span class="keyword">return</span> delegate-&gt;RunProcess(process_type, main_function_params);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>先建立了一个进程类型和入口函数指针的对应数组，再根据进程类型去具体执行，执行的过程与 <code>Browser</code> 进程一样，先通过 <code>delegate-&gt;RunProcess</code> 交由 <code>Embedder</code> 层处理，如果未处理再调用默认的进程入口函数，可以看到分别提供了 <code>UtilityMain</code>、<code>RendererMain</code>、<code>GpuMain</code> 这三个进程的入口，其中 <code>RendererMain</code> 则是我们关注的 <code>Renderer</code> 进程的入口函数，<code>Renderer</code> 进程从此处开始执行。最后一句，如果进程类型不在以上范围内，则交由 <code>Embedder</code> 去处理。</p>
<h2 id="9、程序结束"><a href="#9、程序结束" class="headerlink" title="9、程序结束"></a>9、程序结束</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ContentMainRunnerImpl::Shutdown</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  DCHECK(is_initialized_);</span><br><span class="line">  DCHECK(!is_shutdown_);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (completed_basic_startup_) &#123;</span><br><span class="line">    <span class="keyword">const</span> base::CommandLine&amp; command_line =</span><br><span class="line">        *base::CommandLine::ForCurrentProcess();</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">string</span> process_type =</span><br><span class="line">        command_line.GetSwitchValueASCII(switches::kProcessType);</span><br><span class="line"></span><br><span class="line">    delegate_-&gt;ProcessExiting(process_type);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> !defined(CHROME_MULTIPLE_DLL_CHILD)</span></span><br><span class="line">  <span class="comment">// The BrowserTaskExecutor needs to be destroyed before |exit_manager_|.</span></span><br><span class="line">  BrowserTaskExecutor::Shutdown();</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span>  <span class="comment">// !defined(CHROME_MULTIPLE_DLL_CHILD)</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(OS_WIN)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> _CRTDBG_MAP_ALLOC</span></span><br><span class="line">  _CrtDumpMemoryLeaks();</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span>  <span class="comment">// _CRTDBG_MAP_ALLOC</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span>  <span class="comment">// OS_WIN</span></span></span><br><span class="line"></span><br><span class="line">  exit_manager_.reset(<span class="literal">nullptr</span>);</span><br><span class="line"></span><br><span class="line">  delegate_ = <span class="literal">nullptr</span>;</span><br><span class="line">  is_shutdown_ = <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>首先通过 <code>delegate_-&gt;ProcessExiting(process_type)</code> 通知 <code>Embedder</code> 层处理，然后做了一些善后释放的工作，最后将 <code>is_shutdown_</code> 标记置为 <code>true</code>。</p>
<h2 id="10、总结"><a href="#10、总结" class="headerlink" title="10、总结"></a>10、总结</h2><img src="/2019/04/01/chromium-startup/startup.png" class="" title="启动相关类图">
<p>前面分析了这么多，其实结合类图来看一下还是很简单明了的，主要起到作用的就是图中标红的三个，<code>service_manager::Main</code> 通过 <code>content::ContentServiceManagerMainDelegate</code> 的实例调用了 <code>content::ContentMainRunnerImpl</code> 实例中的 <code>Initialize()</code>、<code>Run()</code>、<code>Shutdown()</code> 函数，而在这个Runner中，又通过 <code>content::ContentMainDelegate</code> 接口指针调用到了由 <code>Embedder</code> 层创建的 <code>ChromeMainDelegate</code> 实例中的函数，由此完成了程序的启动以及 <code>Content</code> 层对 <code>Embedder</code> 的交互。</p>

      

      
        
    </div>
  </div>
  
</article>



  
    <article id="post-centos6-7-oracle" class="article article-type-post" itemscope itemprop="blogPost">
  
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/04/01/centos6-7-oracle/">CentOS 6.7 安装 Oracle 11g2</a>
    </h1>
  

      </header>
    
    <div class="article-meta">
      <a href="/2019/04/01/centos6-7-oracle/" class="article-date">
  <time datetime="2019-04-01T06:15:23.000Z" itemprop="datePublished">2019-04-01</time>
</a>
      
    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="一、准备工作"><a href="#一、准备工作" class="headerlink" title="一、准备工作"></a>一、准备工作</h1><h2 id="1-配hosts文件"><a href="#1-配hosts文件" class="headerlink" title="1 配hosts文件"></a>1 配hosts文件</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> sudo vi /etc/hosts</span></span><br></pre></td></tr></table></figure>
<p>添加以下内容：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">192.168.1.58 oracle</span><br></pre></td></tr></table></figure>
<h2 id="2-关闭SELINUX"><a href="#2-关闭SELINUX" class="headerlink" title="2 关闭SELINUX"></a>2 关闭SELINUX</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> sudo setenforce 0</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> sudo vi /etc/selinux/config</span></span><br></pre></td></tr></table></figure>
<p>修改文件内容：</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">SELINUX</span>=disabled</span><br></pre></td></tr></table></figure>
<h2 id="3-关闭防火墙"><a href="#3-关闭防火墙" class="headerlink" title="3 关闭防火墙"></a>3 关闭防火墙</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> sudo service iptables stop</span></span><br></pre></td></tr></table></figure>
<h2 id="4-安装依赖包"><a href="#4-安装依赖包" class="headerlink" title="4 安装依赖包"></a>4 安装依赖包</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> sudo yum install binutils compat-libstdc++ cpp elfutils elfutils-libelf elfutils-libelf-devel elfutils-libs gcc gcc-c++ glibc glibc-common glibc-devel glibc-headers ksh libaio libaio-devel libgcc libgomp libstdc++ libstdc++-devel make mpfr nss-softokn-freebl sysstat tzdata-java unixODBC unixODBC-devel cloog-ppl kernel-headers libtool-ltdl ppl</span></span><br></pre></td></tr></table></figure>
<h2 id="5-创建用户、组"><a href="#5-创建用户、组" class="headerlink" title="5 创建用户、组"></a>5 创建用户、组</h2><p>没有建特别的用户组，直接用了默认的，并把oracle加入sudo</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> sudo adduser oracle</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> sudo passwd oracle</span></span><br></pre></td></tr></table></figure>
<h2 id="6-创建安装目录"><a href="#6-创建安装目录" class="headerlink" title="6 创建安装目录"></a>6 创建安装目录</h2><p>把oracle安装在 <code>/opt/oracle</code> 下面</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> sudo mkdir -p /opt/oracle</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> sudo mkdir -p /opt/oracle/product/112010/db_1</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> sudo mkdir /opt/oracle/oradata</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> sudo mkdir /opt/oracle/inventory</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> sudo mkdir /opt/oracle/flash_recovery_area</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> sudo chown -R oracle:oracle /opt/oracle</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> sudo chmod -R 775 /opt/oracle</span></span><br></pre></td></tr></table></figure>
<h2 id="7-修改内核参数"><a href="#7-修改内核参数" class="headerlink" title="7 修改内核参数"></a>7 修改内核参数</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> sudo vi /etc/sysctl.conf</span></span><br></pre></td></tr></table></figure>
<p>修改文件内容：</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">fs.aio-max-nr</span> = <span class="number">1048576</span>  <span class="comment"># 指的是可以同时拥有异步I/O请求的数目，Oracle推荐的值为1048576（1024×1024），也就是1024Kb个。</span></span><br><span class="line"><span class="attr">fs.file-max</span> = <span class="number">6815744</span>  <span class="comment"># 系统所有进程一共可以打开的文件数量 64bytes  cat /proc/sys/fs/file-nr 在&#x27;高负荷&#x27;的情况，看看有多少文件描述符都在使用。</span></span><br><span class="line"><span class="attr">kernel.shmmni</span> = <span class="number">4096</span>  <span class="comment"># 整个系统共享内存段的最大数量。</span></span><br><span class="line"><span class="attr">kernel.sem</span> = <span class="number">250</span> <span class="number">32000</span> <span class="number">100</span> <span class="number">128</span></span><br><span class="line">    <span class="comment"># 1.同一类信号的最多数量(semmsl)。</span></span><br><span class="line">    <span class="comment"># 2.系统中信号的最多数目，=semmni*semmsl (semmns)。</span></span><br><span class="line">    <span class="comment"># 3.每个semop系统调用所包含的最大的操作数(能调用的信号量的最多次数) (semopm)。</span></span><br><span class="line">    <span class="comment"># 4.系统中信号类型的数目的最大值，一个信号量标识符代表一个类型(semmni)。</span></span><br><span class="line"><span class="attr">net.ipv4.ip_local_port_range</span> = <span class="number">32768</span> <span class="number">61000</span>  <span class="comment"># 表示TCP/UDP协议打开的本地端口号。 默认设置：1024 4999 建议设置：32768 61000。</span></span><br><span class="line"><span class="attr">net.core.rmem_default</span> = <span class="number">262144</span>  <span class="comment"># 设置接收socket的缺省缓存大小(字节)。</span></span><br><span class="line"><span class="attr">net.core.rmem_max</span> = <span class="number">4194304</span>  <span class="comment"># 设置接收socket的最大缓存大小(字节)</span></span><br><span class="line"><span class="attr">net.core.wmem_default</span> = <span class="number">212992</span>  <span class="comment"># 设置发送的socket缺省缓存大小(字节)</span></span><br><span class="line"><span class="attr">net.core.wmem_max</span> = <span class="number">1048576</span>  <span class="comment"># 设置发送的socket最大缓存大小(字节)</span></span><br></pre></td></tr></table></figure>
<p>保存后执行：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> sudo sysctl -p</span></span><br></pre></td></tr></table></figure>
<h2 id="8-修改用户限制文件（配置项未理解）"><a href="#8-修改用户限制文件（配置项未理解）" class="headerlink" title="8 修改用户限制文件（配置项未理解）"></a>8 修改用户限制文件（配置项未理解）</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> sudo vi /etc/security/limits.conf</span></span><br></pre></td></tr></table></figure>
<p>添加以下内容：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">oracle          soft    nproc   2047</span><br><span class="line">oracle          hard    nproc   16384</span><br><span class="line">oracle          soft    nofile  1024</span><br><span class="line">oracle          hard    nofile  65536</span><br><span class="line">oracle          soft    stack   10240</span><br></pre></td></tr></table></figure>
<h2 id="9-关联设置（暂时不知道干嘛用的）"><a href="#9-关联设置（暂时不知道干嘛用的）" class="headerlink" title="9 关联设置（暂时不知道干嘛用的）"></a>9 关联设置（暂时不知道干嘛用的）</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> sudo vi /etc/pam.d/login</span></span><br></pre></td></tr></table></figure>
<p>添加以下内容：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">session required  /lib64/security/pam_limits.so</span><br><span class="line">session required   pam_limits.so</span><br></pre></td></tr></table></figure>
<h2 id="10-修改-etc-profile（暂时不知道干嘛用的）"><a href="#10-修改-etc-profile（暂时不知道干嘛用的）" class="headerlink" title="10 修改/etc/profile（暂时不知道干嘛用的）"></a>10 修改/etc/profile（暂时不知道干嘛用的）</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> sudo vi /etc/profile</span></span><br></pre></td></tr></table></figure>
<p>添加以下内容：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> [ <span class="variable">$USER</span> = <span class="string">&quot;oracle&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="keyword">if</span> [ <span class="variable">$SHELL</span> = <span class="string">&quot;/bin/ksh&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">ulimit</span> -p 16384</span><br><span class="line">        <span class="built_in">ulimit</span> -n 65536</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">ulimit</span> -u 16384 -n 65536</span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure>
<p>切换至root账号下使之生效：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> su root</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">source</span> /etc/profile</span></span><br></pre></td></tr></table></figure>
<h2 id="11-修改oracle用户环境变量"><a href="#11-修改oracle用户环境变量" class="headerlink" title="11 修改oracle用户环境变量"></a>11 修改oracle用户环境变量</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">cd</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> vi .bash_profile</span></span><br></pre></td></tr></table></figure>
<p>添加以下内容：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># for oracle</span></span><br><span class="line"><span class="built_in">export</span> ORACLE_BASE=/opt/oracle;</span><br><span class="line"><span class="built_in">export</span> ORACLE_HOME=/opt/oracle/product/112010/db_1</span><br><span class="line"><span class="built_in">export</span> ORACLE_SID=orcl;</span><br><span class="line"><span class="built_in">export</span> PATH=<span class="variable">$PATH</span>:<span class="variable">$HOME</span>/bin:<span class="variable">$ORACLE_HOME</span>/bin</span><br><span class="line"><span class="built_in">export</span> LD_LIBRARY_PATH=<span class="variable">$ORACLE_HOME</span>/lib:/usr/lib</span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$USER</span> = <span class="string">&quot;oracle&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="keyword">if</span> [ <span class="variable">$SHELL</span> = <span class="string">&quot;/bin/ksh&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">ulimit</span> -p 16384</span><br><span class="line">        <span class="built_in">ulimit</span> -n 65536</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">ulimit</span> -u 16384 -n 65536</span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">    <span class="built_in">umask</span> 022</span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure>
<p>使之生效：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">source</span> .bash_profile</span></span><br></pre></td></tr></table></figure>
<p>此时若命令执行失败，提示：<code>-bash: ulimit: open files: cannot modify limit: Operation not permitted</code>，是因为ssh登录的缘故，需要修改sshd配置如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> sudo vi /etc/ssh/sshd_config</span></span><br></pre></td></tr></table></figure>
<p>把UseLogin改为yes，重启ssh：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> sudo service sshd restart</span></span><br></pre></td></tr></table></figure>
<p>重点，这里重启完sshd之后，一定要exit后重新用ssh连接，否则依然会报错</p>
<h1 id="二、正式开始安装"><a href="#二、正式开始安装" class="headerlink" title="二、正式开始安装"></a>二、正式开始安装</h1><h2 id="1-准备安装文件"><a href="#1-准备安装文件" class="headerlink" title="1 准备安装文件"></a>1 准备安装文件</h2><p>把解压后的database文件夹放到 <code>/opt/oralce/</code> 下</p>
<h2 id="2-编辑oracle数据库安装应答文件"><a href="#2-编辑oracle数据库安装应答文件" class="headerlink" title="2 编辑oracle数据库安装应答文件"></a>2 编辑oracle数据库安装应答文件</h2><p>修改db_install.rsp</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> vi db_install.rsp</span></span><br></pre></td></tr></table></figure>
<p>修改文件内容：</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">oracle.install.option</span>=INSTALL_DB_SWONLY  <span class="comment"># 29行 安装类型</span></span><br><span class="line"><span class="attr">ORACLE_HOSTNAME</span>=chances  <span class="comment"># 37行 主机名称</span></span><br><span class="line"><span class="attr">UNIX_GROUP_NAME</span>=oracle  <span class="comment"># 42行 安装组</span></span><br><span class="line"><span class="attr">INVENTORY_LOCATION</span>=/opt/oracle/inventory  <span class="comment"># 47行 INVENTORY目录</span></span><br><span class="line"><span class="attr">SELECTED_LANGUAGES</span>=en,zh_CN  <span class="comment"># 78行 选择语言，可能因为linux是en的，所以这里一定要加上en</span></span><br><span class="line"><span class="attr">ORACLE_HOME</span>=/opt/oracle/product/<span class="number">112010</span>/db_1  <span class="comment"># 83行 oracle_home</span></span><br><span class="line"><span class="attr">ORACLE_BASE</span>=/opt/oracle  <span class="comment"># 88行 oracle_base</span></span><br><span class="line"><span class="attr">oracle.install.db.InstallEdition</span>=EE  <span class="comment"># 99行 oracle版本</span></span><br><span class="line"><span class="attr">oracle.install.db.DBA_GROUP</span>=oracle  <span class="comment"># 142行 dba用户组</span></span><br><span class="line"><span class="attr">oracle.install.db.OPER_GROUP</span>=oracle  <span class="comment"># 147行 oper用户组</span></span><br><span class="line"><span class="attr">oracle.install.db.config.starterdb.type</span>=GENERAL_PURPOSE  <span class="comment"># 160行 数据库类型</span></span><br><span class="line"><span class="attr">oracle.install.db.config.starterdb.globalDBName</span>=orcl  <span class="comment"># 165行 globalDBName</span></span><br><span class="line"><span class="attr">oracle.install.db.config.starterdb.SID</span>=orcl  <span class="comment"># 170行 SID</span></span><br><span class="line"><span class="attr">oracle.install.db.config.starterdb.memoryLimit</span>=<span class="number">800</span>  <span class="comment"># 200行 自动管理内存的最小内存(M)</span></span><br><span class="line"><span class="attr">oracle.install.db.config.starterdb.password.ALL</span>=xxxx  <span class="comment"># 233行 设定所有数据库用户使用同一个密码</span></span><br><span class="line"><span class="attr">DECLINE_SECURITY_UPDATES</span>=<span class="literal">true</span>  <span class="comment"># 385行 设置安全更新</span></span><br></pre></td></tr></table></figure>
<h2 id="3-开始安装"><a href="#3-开始安装" class="headerlink" title="3 开始安装"></a>3 开始安装</h2><p>用oracle账号进入 <code>/opt/oracle/database/</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> su oracle</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">cd</span> /opt/oracle/database/</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ./runInstaller -silent -responseFile /opt/oracle/database/response/db_install.rsp -ignorePrereq</span></span><br></pre></td></tr></table></figure>
<p>在日志里看到这个就成功了：</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="regexp">/opt/</span>oracle<span class="regexp">/inventory/</span>orainstRoot.sh</span><br><span class="line"><span class="regexp">/opt/</span>oracle<span class="regexp">/product/</span><span class="number">112010</span><span class="regexp">/db_1/</span>root.sh</span><br><span class="line">To execute the configuration scripts:</span><br><span class="line">        <span class="number">1</span>. Open a terminal window</span><br><span class="line">        <span class="number">2</span>. Log in as <span class="string">&quot;root&quot;</span></span><br><span class="line">        <span class="number">3</span>. Run the scripts</span><br><span class="line">        <span class="number">4</span>. <span class="keyword">Return</span> to <span class="keyword">this</span> window and hit <span class="string">&quot;Enter&quot;</span> key to <span class="keyword">continue</span></span><br></pre></td></tr></table></figure>
<p>用root用户登录按提示执行脚本：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> /opt/oracle/inventory/orainstRoot.sh</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> /opt/oracle/product/112010/db_1/root.sh</span></span><br></pre></td></tr></table></figure>
<h2 id="4-配置监听"><a href="#4-配置监听" class="headerlink" title="4 配置监听"></a>4 配置监听</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> vi /opt/oracle/database/response/netca.rsp</span></span><br></pre></td></tr></table></figure>
<p>检查这些参数：</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">INSTALL_TYPE</span>=<span class="string">&quot;&quot;</span>custom<span class="string">&quot;&quot;</span>  <span class="comment">#安装的类型</span></span><br><span class="line"><span class="attr">LISTENER_NUMBER</span>=<span class="number">1</span>  <span class="comment">#监听器数量</span></span><br><span class="line"><span class="attr">LISTENER_NAMES</span>=&#123;<span class="string">&quot;LISTENER&quot;</span>&#125;  <span class="comment">#监听器的名称列表</span></span><br><span class="line"><span class="attr">LISTENER_PROTOCOLS</span>=&#123;<span class="string">&quot;TCP;1521&quot;</span>&#125;  <span class="comment">#监听器使用的通讯协议列表</span></span><br><span class="line"><span class="attr">LISTENER_START</span>=<span class="string">&quot;&quot;</span>LISTENER<span class="string">&quot;&quot;</span>  <span class="comment">#监听器启动的名称</span></span><br></pre></td></tr></table></figure>
<p>保存后运行：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> netca -silent -responseFile /opt/oracle/database/response/netca.rsp</span></span><br></pre></td></tr></table></figure>
<h1 id="三、添加数据库实例"><a href="#三、添加数据库实例" class="headerlink" title="三、添加数据库实例"></a>三、添加数据库实例</h1><h2 id="1-检查配置"><a href="#1-检查配置" class="headerlink" title="1 检查配置"></a>1 检查配置</h2><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">RESPONSEFILE_VERSION</span> = <span class="string">&quot;11.2.0&quot;</span>  <span class="comment">#不能更改</span></span><br><span class="line"><span class="attr">OPERATION_TYPE</span> = <span class="string">&quot;createDatabase&quot;</span></span><br><span class="line"><span class="attr">GDBNAME</span> = <span class="string">&quot;orcl&quot;</span>  <span class="comment">#数据库的名字</span></span><br><span class="line"><span class="attr">SID</span> = <span class="string">&quot;ORCL&quot;</span>  <span class="comment">#对应的实例名字</span></span><br><span class="line"><span class="attr">TEMPLATENAME</span> = <span class="string">&quot;General_Purpose.dbc&quot;</span>  <span class="comment">#建库用的模板文件</span></span><br><span class="line"><span class="attr">SYSPASSWORD</span> = <span class="string">&quot;oracle&quot;</span>  <span class="comment">#SYS管理员密码</span></span><br><span class="line"><span class="attr">SYSTEMPASSWORD</span> = <span class="string">&quot;sys&quot;</span>  <span class="comment">#SYSTEM管理员密码</span></span><br><span class="line"><span class="attr">SYSMANPASSWORD</span> = <span class="string">&quot;sys&quot;</span></span><br><span class="line"><span class="attr">DBSNMPPASSWORD</span> = <span class="string">&quot;sys&quot;</span></span><br><span class="line"><span class="attr">DATAFILEDESTINATION</span> = /opt/oracle/oradata  <span class="comment">#数据文件存放目录</span></span><br><span class="line"><span class="attr">RECOVERYAREADESTINATION</span> = /opt/oracle/flash_recovery_area  <span class="comment">#恢复数据存放目录</span></span><br><span class="line"><span class="attr">CHARACTERSET</span> = <span class="string">&quot;ZHS16GBK&quot;</span>  <span class="comment">#字符集，重要!!!建库后一般不能更改，所以建库前要确定清楚。</span></span><br><span class="line"><span class="attr">TOTALMEMORY</span> = <span class="string">&quot;10240&quot;</span>  <span class="comment">#10240MB，物理内存10G。</span></span><br></pre></td></tr></table></figure>
<h2 id="2-安装实例"><a href="#2-安装实例" class="headerlink" title="2 安装实例"></a>2 安装实例</h2><p>进入oracle的bin目录运行：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> dbca -silent -responseFile /opt/oracle/database/response/dbca.rsp</span></span><br></pre></td></tr></table></figure>
<p>查看实例进程：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> ps -ef | grep ora_ | grep -v grep</span></span><br></pre></td></tr></table></figure>
<p>查看监听状态：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> lsnrctl status</span></span><br></pre></td></tr></table></figure>
<p>修改以下几个文件：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> vi /opt/oracle/product/112010/db_1/bin/dbstart</span></span><br></pre></td></tr></table></figure>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">ORACLE_HOME_LISTNER</span>=<span class="variable">$ORACLE_HOME</span></span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> vi /opt/oracle/product/112010/db_1/bin/dbshut</span></span><br></pre></td></tr></table></figure>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">ORACLE_HOME_LISTNER</span>=<span class="variable">$ORACLE_HOME</span></span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> vi /etc/oratab</span></span><br></pre></td></tr></table></figure>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">orcl:/opt/oracle/product/112010/db_1:Y</span><br></pre></td></tr></table></figure>
<p>使用 <code>dbshut、dbstart</code> 可以测试，查看监听状态</p>
<h1 id="四、结束"><a href="#四、结束" class="headerlink" title="四、结束"></a>四、结束</h1><p>打开selinux</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> sudo vi /etc/selinux/config</span></span><br></pre></td></tr></table></figure>
      

      
        
    </div>
  </div>
  
</article>



  
    <article id="post-about-ubuntu" class="article article-type-post" itemscope itemprop="blogPost">
  
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/04/12/about-ubuntu/">ubuntu相关笔记</a>
    </h1>
  

      </header>
    
    <div class="article-meta">
      <a href="/2018/04/12/about-ubuntu/" class="article-date">
  <time datetime="2018-04-12T12:48:06.000Z" itemprop="datePublished">2018-04-12</time>
</a>
      
    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="挂载硬盘"><a href="#挂载硬盘" class="headerlink" title="挂载硬盘"></a>挂载硬盘</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> sudo mkfs.ext4  /dev/sdb</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> sudo blkid</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> sudo vi /etc/fstab</span></span><br></pre></td></tr></table></figure>
<p>修改文件内容：</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">UUID</span>=a450131d-<span class="number">8</span>c83-<span class="number">4092</span>-a028-<span class="number">887</span>b7f6495b5 /mnt/xxx ext4 defaults <span class="number">0</span> <span class="number">1</span></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ sudo mount -a</span><br><span class="line">$ sudo chown -R xxx:xxx /mnt/xxx</span><br></pre></td></tr></table></figure>
<h2 id="18-04配置网络"><a href="#18-04配置网络" class="headerlink" title="18.04配置网络"></a>18.04配置网络</h2><p>不再使用 <code>/etc/network/interfaces</code></p>
<p>修改 <code>/etc/netplan/xxxxx.yaml</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">network:</span><br><span class="line">  ethernets:</span><br><span class="line">    ens33:</span><br><span class="line">      dhcp4: no</span><br><span class="line">      addresses: [192.168.1.30/24]</span><br><span class="line">      gateway4: 192.168.1.1</span><br><span class="line">      nameservers:</span><br><span class="line">        addresses: [114.114.114.114,8.8.8.8]</span><br><span class="line">  version: 2</span><br></pre></td></tr></table></figure>
<p>改完后 <code>sudo netplay apply</code></p>

      

      
        
    </div>
  </div>
  
</article>



  
    <article id="post-about-oracle" class="article article-type-post" itemscope itemprop="blogPost">
  
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/09/17/about-oracle/">记点Oracle的东西</a>
    </h1>
  

      </header>
    
    <div class="article-meta">
      <a href="/2017/09/17/about-oracle/" class="article-date">
  <time datetime="2017-09-17T15:47:58.000Z" itemprop="datePublished">2017-09-17</time>
</a>
      
    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="表空间用户相关的东西"><a href="#表空间用户相关的东西" class="headerlink" title="表空间用户相关的东西"></a>表空间用户相关的东西</h1><p>遇到一个删除表空间失败的情况，先删用户，再删表空间：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">drop</span> <span class="keyword">user</span> xxx <span class="keyword">cascade</span>;</span><br><span class="line"><span class="keyword">drop</span> <span class="keyword">tablespace</span> xxx <span class="keyword">including</span> <span class="keyword">contents</span> <span class="keyword">and</span> <span class="keyword">datafiles</span>;</span><br></pre></td></tr></table></figure>
<p>建表空间：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">tablespace</span> XXX</span><br><span class="line"><span class="keyword">datafile</span> <span class="string">&#x27;D:\Data\oradata\orcl\XXX.DBF&#x27;</span> <span class="keyword">size</span> <span class="number">50</span>M</span><br><span class="line"><span class="keyword">autoextend</span> <span class="keyword">on</span></span><br><span class="line"><span class="keyword">next</span> <span class="number">10</span>M</span><br><span class="line"><span class="keyword">extent</span> <span class="keyword">management</span> <span class="keyword">local</span>;</span><br></pre></td></tr></table></figure>
<p>建用户：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">user</span> XXX <span class="keyword">identified</span> <span class="keyword">by</span> xxx</span><br><span class="line"><span class="keyword">default</span> <span class="keyword">tablespace</span> XXX</span><br><span class="line"><span class="keyword">temporary</span> <span class="keyword">tablespace</span> TEMP;</span><br></pre></td></tr></table></figure>
<p>给用户赋权：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">grant</span> <span class="keyword">connect</span>, <span class="keyword">resource</span>, dba <span class="keyword">to</span> xxx;</span><br></pre></td></tr></table></figure>
<p>有一次把表空间文件给删了，但是表空间还在，得想办法把表空间删掉：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">alter</span> <span class="keyword">database</span> <span class="keyword">datafile</span> <span class="string">&#x27;XXX&#x27;</span> <span class="keyword">offline</span> <span class="keyword">drop</span>;</span><br></pre></td></tr></table></figure>
<p>非常简单的一句</p>
<h1 id="下面是关于Oracle-11g导出空表的方法"><a href="#下面是关于Oracle-11g导出空表的方法" class="headerlink" title="下面是关于Oracle 11g导出空表的方法"></a>下面是关于Oracle 11g导出空表的方法</h1><p>Oracle 11g开始，exp的时候，默认情况下是不会导出无数据的空表的，这时候要分两部分解决，其一修改设置，让以后建立的新表都能导出空表，另外一个则是对已有的数据表进行设置，具体做法如下：</p>
<h2 id="1、设置deferred-segment-creation-参数"><a href="#1、设置deferred-segment-creation-参数" class="headerlink" title="1、设置deferred_segment_creation 参数"></a>1、设置deferred_segment_creation 参数</h2><p>查看当前设置：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> parameter deferred_segment_creation</span><br></pre></td></tr></table></figure>
<p>修改参数：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">alter</span> <span class="keyword">system</span> <span class="keyword">set</span> deferred_segment_creation=<span class="literal">false</span>;</span><br></pre></td></tr></table></figure>
<h2 id="2、处理已有的空表："><a href="#2、处理已有的空表：" class="headerlink" title="2、处理已有的空表："></a>2、处理已有的空表：</h2><p>先找到所有的空表：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> table_name <span class="keyword">from</span> user_tables <span class="keyword">where</span> NUM_ROWS=<span class="number">0</span>;</span><br></pre></td></tr></table></figure>
<p>把结果存到一个临时表里：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="string">&#x27;alter table &#x27;</span>||table_name||<span class="string">&#x27; allocate extent;&#x27;</span> <span class="keyword">from</span> user_tables <span class="keyword">where</span> num_rows=<span class="number">0</span>;</span><br></pre></td></tr></table></figure>
<p>把查询结果作为语句执行一遍就O了。</p>

      

      
        
    </div>
  </div>
  
</article>



  
    <article id="post-centos7-systemctl" class="article article-type-post" itemscope itemprop="blogPost">
  
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/08/15/centos7-systemctl/">CentOS 7 利用 systemctl 安装自动启服务</a>
    </h1>
  

      </header>
    
    <div class="article-meta">
      <a href="/2017/08/15/centos7-systemctl/" class="article-date">
  <time datetime="2017-08-15T12:45:41.000Z" itemprop="datePublished">2017-08-15</time>
</a>
      
    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <p>在 <code>/usr/lib/systemd/system</code> 文件夹下建立文件 <code>shadowsocks.service</code>，文件内容如下：</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[Unit]</span></span><br><span class="line"><span class="attr">Description</span>=Shadowsocks Server</span><br><span class="line"><span class="attr">After</span>=network.target remote-fs.target nss-lookup.target</span><br><span class="line"></span><br><span class="line"><span class="section">[Service]</span></span><br><span class="line"><span class="attr">Type</span>=forking</span><br><span class="line"><span class="attr">PIDFile</span>=/var/shadowsocks/pid</span><br><span class="line"><span class="attr">ExecStart</span>=/usr/bin/ssserver -c /var/shadowsocks/conf.json -d start</span><br><span class="line"><span class="attr">ExecReload</span>=/usr/bin/ssserver -c /var/shadowsocks/conf.json -d restart</span><br><span class="line"><span class="attr">ExecStop</span>=/usr/bin/ssserver -d stop</span><br><span class="line"><span class="attr">PrivateTmp</span>=<span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="section">[Install]</span></span><br><span class="line"><span class="attr">WantedBy</span>=multi-user.target</span><br></pre></td></tr></table></figure>
<p>给文件加上754权限：<code>chmod +754 shadowsocks.service</code>。</p>
<ul>
<li>用 <code>systemctl start shadowsocks.service</code> 就可以启动服务。</li>
<li>用 <code>systemctl enable shadowsocks.service</code> 就可以启用自动启服务。</li>
</ul>

      

      
        
    </div>
  </div>
  
</article>



  
  
    <nav id="page-nav">
      <a class="extend prev" rel="prev" href="/page/3/">&lt; Prev</a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><span class="page-number current">4</span><a class="page-number" href="/page/5/">5</a><a class="extend next" rel="next" href="/page/5/">Next &gt;</a>
    </nav>
  
</section>
        <aside id="sidebar">
  <nav class="menus">
  	<ul>
  		<li><a href="/"><i class="icon icon-home"></i></a></li>
  		
			<li><a href="/archives"><i class="icon icon-fenlei"></i></a></li>
  		
  		
			<li><a href="/tags"><i class="icon icon-tag"></i></a></li>
  		
  		
  			<li><a href="https://github.com/singlesword" target="_blank"><i class="icon icon-github"></i></a></li>
  		
  	</ul>
  </nav>
  <a id="go-top" href="#"><i class="icon icon-up"></i></a>
</aside>

      </div>
      <footer id="footer">
  
	<div id="footer-info" class="inner">
	  &copy; 2021 YangXC 
	  - Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
	  - Theme <a href="https://github.com/hejianxian/hexo-theme-jane/" target="_blank">Jane</a>
	</div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
    <a href="/tags" class="mobile-nav-link">Tag</a>
  
    <a target="_blank" rel="noopener" href="https://github.com/singlesword" class="mobile-nav-link">Github</a>
  
</nav>
    

<script src="//cdn.bootcss.com/jquery/2.0.3/jquery.min.js"></script>


  
<link rel="stylesheet" href="/fancybox/jquery.fancybox.css">

  
<script src="/fancybox/jquery.fancybox.pack.js"></script>




<script src="/js/script.js"></script>


  </div>
</body>
</html>