<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Chromium学习笔记：程序启动入口分析（Windows） | 尼玛豹哥</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="以下笔记内容均为Windows版本。 本篇笔记跟踪记录了Chromium的启动过程，主要关注 Browser 进程和 Renderer 进程。根据 Chromium 项目的分层设计，我们把 Content API 称作为 Content 层，而把调用 Content API 实现浏览器程序的部分称作为 Embedder 层。在项目中，Embedder 层有 chrome、content_shell">
<meta property="og:type" content="article">
<meta property="og:title" content="Chromium学习笔记：程序启动入口分析（Windows）">
<meta property="og:url" content="http://blog.yangxc.com/2019/04/01/chromium-startup/index.html">
<meta property="og:site_name" content="尼玛豹哥">
<meta property="og:description" content="以下笔记内容均为Windows版本。 本篇笔记跟踪记录了Chromium的启动过程，主要关注 Browser 进程和 Renderer 进程。根据 Chromium 项目的分层设计，我们把 Content API 称作为 Content 层，而把调用 Content API 实现浏览器程序的部分称作为 Embedder 层。在项目中，Embedder 层有 chrome、content_shell">
<meta property="og:locale">
<meta property="og:image" content="http://blog.yangxc.com/2019/04/01/chromium-startup/startup.png">
<meta property="article:published_time" content="2019-04-01T06:34:31.000Z">
<meta property="article:modified_time" content="2021-04-13T02:59:22.288Z">
<meta property="article:author" content="YangXC">
<meta property="article:tag" content="chromium">
<meta property="article:tag" content="main">
<meta property="article:tag" content="browser">
<meta property="article:tag" content="renderer">
<meta property="article:tag" content="startup">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://blog.yangxc.com/2019/04/01/chromium-startup/startup.png">
  
    <link rel="alternative" href="/atom.xml" title="尼玛豹哥" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.ico">
  
  <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
<link rel="stylesheet" href="/css/style.css">

  

<meta name="generator" content="Hexo 5.3.0"></head>
<body>
  <div id="container">
    <div id="wrap">
      <div id="blog-header">
  <img src="/images/avatar.jpg">
  <div id="blog-title">尼玛豹哥</div>
</div>
<hr id="header-line">

      <div class="outer">
        <section id="main"><article id="post-chromium-startup" class="article article-type-post" itemscope itemprop="blogPost">
  
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Chromium学习笔记：程序启动入口分析（Windows）
    </h1>
  

      </header>
    
    <div class="article-meta">
      <a href="/2019/04/01/chromium-startup/" class="article-date">
  <time datetime="2019-04-01T06:34:31.000Z" itemprop="datePublished">2019-04-01</time>
</a>
      
    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <p>以下笔记内容均为Windows版本。</p>
<p>本篇笔记跟踪记录了Chromium的启动过程，主要关注 <code>Browser</code> 进程和 <code>Renderer</code> 进程。根据 <code>Chromium</code> 项目的分层设计，我们把 <code>Content API</code> 称作为 <code>Content</code> 层，而把调用 <code>Content API</code> 实现浏览器程序的部分称作为 <code>Embedder</code> 层。在项目中，<code>Embedder</code> 层有 <code>chrome</code>、<code>content_shell</code> 等多种实现。</p>
<h2 id="1、main-函数"><a href="#1、main-函数" class="headerlink" title="1、main() 函数"></a>1、main() 函数</h2><p>Chromium的main函数在 <code>chrome\app\chrome_exe_main_win.cc</code>，具体如下：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// chrome\app\chrome_exe_main_win.cc</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> !defined(WIN_CONSOLE_APP)</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> APIENTRY <span class="title">wWinMain</span><span class="params">(HINSTANCE instance, HINSTANCE prev, <span class="keyword">wchar_t</span>*, <span class="keyword">int</span>)</span> </span>&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  HINSTANCE instance = GetModuleHandle(<span class="literal">nullptr</span>);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">  install_static::InitializeFromPrimaryModule();</span><br><span class="line">  SignalInitializeCrashReporting();</span><br><span class="line"></span><br><span class="line">  ......</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Load and launch the chrome dll. *Everything* happens inside.</span></span><br><span class="line">  VLOG(<span class="number">1</span>) &lt;&lt; <span class="string">&quot;About to load main DLL.&quot;</span>;</span><br><span class="line">  MainDllLoader* loader = MakeMainDllLoader();</span><br><span class="line">  <span class="keyword">int</span> rc = loader-&gt;Launch(instance, exe_entry_point_ticks);</span><br><span class="line">  loader-&gt;RelaunchChromeBrowserWithNewCommandLineIfNeeded();</span><br><span class="line">  <span class="keyword">delete</span> loader;</span><br><span class="line">  <span class="keyword">return</span> rc;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在main函数中，最重要的一步，就是 <code>int rc = loader-&gt;Launch(instance, exe_entry_point_ticks);</code> 载入 <code>chrome.dll运行</code>。</p>
<h2 id="2、载入-chrome-dll"><a href="#2、载入-chrome-dll" class="headerlink" title="2、载入 chrome.dll"></a>2、载入 chrome.dll</h2><p>在这里首先调用了 <code>MakeMainDllLoader()</code> 函数，这是一个静态函数，在<code>chrome\app\main_dll_loader.cc</code> 中，内容如下：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// chrome\app\main_dll_loader.cc</span></span><br><span class="line"></span><br><span class="line"><span class="function">MainDllLoader* <span class="title">MakeMainDllLoader</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(GOOGLE_CHROME_BUILD)</span></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> ChromeDllLoader();</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> ChromiumDllLoader();</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>函数创建并返回一个 <code>ChromiumDllLoader</code>，紧接着再调用它的 <code>Launch</code> 函数，内容如下：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// chrome\app\main_dll_loader.cc</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">MainDllLoader::Launch</span><span class="params">(HINSTANCE instance,</span></span></span><br><span class="line"><span class="function"><span class="params">                          base::TimeTicks exe_entry_point_ticks)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> base::CommandLine&amp; cmd_line = *base::CommandLine::ForCurrentProcess();</span><br><span class="line">  process_type_ = cmd_line.GetSwitchValueASCII(switches::kProcessType);</span><br><span class="line"></span><br><span class="line">  ......</span><br><span class="line"></span><br><span class="line">  dll_ = Load(&amp;file);</span><br><span class="line">  <span class="keyword">if</span> (!dll_)</span><br><span class="line">    <span class="keyword">return</span> chrome::RESULT_CODE_MISSING_DATA;</span><br><span class="line"></span><br><span class="line">  OnBeforeLaunch(cmd_line, process_type_, file);</span><br><span class="line">  DLL_MAIN chrome_main =</span><br><span class="line">      <span class="keyword">reinterpret_cast</span>&lt;DLL_MAIN&gt;(::GetProcAddress(dll_, <span class="string">&quot;ChromeMain&quot;</span>));</span><br><span class="line">  <span class="keyword">int</span> rc = chrome_main(instance, &amp;sandbox_info,</span><br><span class="line">                       exe_entry_point_ticks.ToInternalValue());</span><br><span class="line">  OnBeforeExit(file);</span><br><span class="line">  <span class="keyword">return</span> rc;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里完成了 <code>chrome.dll</code> 的载入，并且执行里面的 <code>ChromeMain</code> 函数。</p>
<h2 id="3、ChromeMain-函数"><a href="#3、ChromeMain-函数" class="headerlink" title="3、ChromeMain() 函数"></a>3、ChromeMain() 函数</h2><p><code>ChromeMain</code> 函数负责 <code>Embedder</code> 层的实现类创建，并传递给 <code>Content</code> 层，定义在 <code>chrome\app\chrome_main.cc</code> 中，内容如下：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// chrome\app\chrome_main.cc</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> &#123;</span><br><span class="line"><span class="function">DLLEXPORT <span class="keyword">int</span> __cdecl <span class="title">ChromeMain</span><span class="params">(HINSTANCE instance,</span></span></span><br><span class="line"><span class="function"><span class="params">                                 sandbox::SandboxInterfaceInfo* sandbox_info,</span></span></span><br><span class="line"><span class="function"><span class="params">                                 <span class="keyword">int64_t</span> exe_entry_point_ticks)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">......</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(OS_WIN)</span></span><br><span class="line"><span class="function">DLLEXPORT <span class="keyword">int</span> __cdecl <span class="title">ChromeMain</span><span class="params">(HINSTANCE instance,</span></span></span><br><span class="line"><span class="function"><span class="params">                                 sandbox::SandboxInterfaceInfo* sandbox_info,</span></span></span><br><span class="line"><span class="function"><span class="params">                                 <span class="keyword">int64_t</span> exe_entry_point_ticks)</span> </span>&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">elif</span> defined(OS_POSIX)</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">ChromeMain</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span>** argv)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">int64_t</span> exe_entry_point_ticks = <span class="number">0</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(OS_WIN)</span></span><br><span class="line">  install_static::InitializeFromPrimaryModule();</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">  <span class="function">ChromeMainDelegate <span class="title">chrome_main_delegate</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">      base::TimeTicks::FromInternalValue(exe_entry_point_ticks))</span></span>;</span><br><span class="line">  <span class="function">content::ContentMainParams <span class="title">params</span><span class="params">(&amp;chrome_main_delegate)</span></span>;</span><br><span class="line"></span><br><span class="line">  ......</span><br><span class="line"></span><br><span class="line">  <span class="keyword">int</span> rv = content::ContentMain(params);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> rv;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>在ChromeMain中，最终执行到了 <code>content::ContentMain</code> 这个函数。</p>
<h2 id="4、content-ContentMain-函数"><a href="#4、content-ContentMain-函数" class="headerlink" title="4、content::ContentMain() 函数"></a>4、content::ContentMain() 函数</h2><p>代码执行到这里，进入了 <code>Content</code> 层，并且传入参数 <code>content::ContentMainParams</code> 类型的参数 <code>params</code>，它是由 <code>Embedder</code> 层传递过来的重要参数，里面包含了 <code>Embedder</code> 层的具体实现信息，此结构体在 <code>content\public\app\content_main.h</code> 中定义如下：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// content\public\app\content_main.h</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ContentMainParams</span> &#123;</span></span><br><span class="line">  <span class="function"><span class="keyword">explicit</span> <span class="title">ContentMainParams</span><span class="params">(ContentMainDelegate* delegate)</span></span></span><br><span class="line"><span class="function">      : <span class="title">delegate</span><span class="params">(delegate)</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">  ContentMainDelegate* delegate;</span><br><span class="line"></span><br><span class="line">  ......</span><br></pre></td></tr></table></figure>
<p>其中有一个重要的成员变量 <code>delegate</code>，其类型为 <code>content::ContentMainDelegate</code>，它在 <code>content\public\app\content_main_delegate.cc</code> 中定义如下：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// content\public\app\content_main_delegate.cc</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CONTENT_EXPORT</span> <span class="title">ContentMainDelegate</span> &#123;</span></span><br><span class="line"> <span class="keyword">public</span>:</span><br><span class="line">  <span class="keyword">virtual</span> ~ContentMainDelegate() &#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="keyword">bool</span> <span class="title">BasicStartupComplete</span><span class="params">(<span class="keyword">int</span>* exit_code)</span></span>;</span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">PreSandboxStartup</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">SandboxInitialized</span><span class="params">(<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span>&amp; process_type)</span> </span>&#123;&#125;</span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="keyword">int</span> <span class="title">RunProcess</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">      <span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span>&amp; process_type,</span></span></span><br><span class="line"><span class="function"><span class="params">      <span class="keyword">const</span> MainFunctionParams&amp; main_function_params)</span></span>;</span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">ProcessExiting</span><span class="params">(<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span>&amp; process_type)</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">  ......</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">PreCreateMainMessageLoop</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">  ......</span><br><span class="line"></span><br><span class="line"> <span class="keyword">protected</span>:</span><br><span class="line">  <span class="keyword">friend</span> <span class="class"><span class="keyword">class</span> <span class="title">ContentClientInitializer</span>;</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> ContentBrowserClient* <span class="title">CreateContentBrowserClient</span><span class="params">()</span></span>;</span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> ContentGpuClient* <span class="title">CreateContentGpuClient</span><span class="params">()</span></span>;</span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> ContentRendererClient* <span class="title">CreateContentRendererClient</span><span class="params">()</span></span>;</span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> ContentUtilityClient* <span class="title">CreateContentUtilityClient</span><span class="params">()</span></span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>可以看到，这里定义了一系列与启动相关的操作，并且通过几个 <code>CreateXXX</code> 的函数，获取 <code>ContentBrowserClient</code>、<code>ContentRendererClient</code> 等接口具体的实现，这也是 <code>content API</code> 的巧妙设计，通过这种方式，将浏览器的实现放入了 <code>content</code> 中。</p>
<p>继续往下看，<code>content::ContentMain()</code> 中调用了 <code>content\app\content_main.cc</code> 中的 <code>service_manager::Main()</code>：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// content\app\content_main.cc</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">ContentMain</span><span class="params">(<span class="keyword">const</span> ContentMainParams&amp; params)</span> </span>&#123;</span><br><span class="line">  <span class="function">ContentServiceManagerMainDelegate <span class="title">delegate</span><span class="params">(params)</span></span>;</span><br><span class="line">  <span class="function">service_manager::MainParams <span class="title">main_params</span><span class="params">(&amp;delegate)</span></span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> !defined(OS_WIN) &amp;&amp; !defined(OS_ANDROID)</span></span><br><span class="line">  main_params.argc = params.argc;</span><br><span class="line">  main_params.argv = params.argv;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">  <span class="keyword">return</span> service_manager::Main(main_params);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在这里，使用一个 <code>content::ContentServiceManagerMainDelegate</code> 对象来构建了 <code>main_params</code>，并传入了 <code>service_manager::Main()</code>。</p>
<h2 id="5、service-manager-Main-函数"><a href="#5、service-manager-Main-函数" class="headerlink" title="5、service_manager::Main 函数"></a>5、service_manager::Main 函数</h2><p><code>service_manager::Main</code> 函数位于 <code>services\service_manager\embedder\main.cc</code>，接收一个 <code>MainParams</code> 类型的参数，具体如下：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// services\service_manager\embedder\main.cc</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">Main</span><span class="params">(<span class="keyword">const</span> MainParams&amp; params)</span> </span>&#123;</span><br><span class="line">  MainDelegate* delegate = params.delegate;</span><br><span class="line"></span><br><span class="line">  ......</span><br><span class="line"></span><br><span class="line">  ProcessType process_type = delegate-&gt;OverrideProcessType();</span><br><span class="line"></span><br><span class="line">  ......</span><br><span class="line">  <span class="comment">// A flag to indicate whether Main() has been called before. On Android, we</span></span><br><span class="line">  <span class="comment">// may re-run Main() without restarting the browser process. This flag</span></span><br><span class="line">  <span class="comment">// prevents initializing things more than once.</span></span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">bool</span> is_initialized = <span class="literal">false</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> !defined(OS_ANDROID)</span></span><br><span class="line">  DCHECK(!is_initialized);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">  <span class="keyword">if</span> (!is_initialized) &#123;</span><br><span class="line">    is_initialized = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">  ......</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(OS_WIN)</span></span><br><span class="line">    base::win::RegisterInvalidParamHandler();</span><br><span class="line">    ui::win::CreateATLModuleIfNeeded();</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span>  <span class="comment">// defined(OS_WIN)</span></span></span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">    base::CommandLine::Init(argc, argv);</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">auto</span>&amp; command_line = *base::CommandLine::ForCurrentProcess();</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(OS_WIN)</span></span><br><span class="line">    base::win::SetupCRT(command_line);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    MainDelegate::InitializeParams init_params;</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line">    mojo::core::Init(mojo_config);</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">    exit_code = delegate-&gt;Initialize(init_params);</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">auto</span>&amp; command_line = *base::CommandLine::ForCurrentProcess();</span><br><span class="line">  <span class="keyword">if</span> (process_type == ProcessType::kDefault) &#123;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">string</span> type_switch =</span><br><span class="line">        command_line.GetSwitchValueASCII(switches::kProcessType);</span><br><span class="line">    <span class="keyword">if</span> (type_switch == switches::kProcessTypeServiceManager) &#123;</span><br><span class="line">      process_type = ProcessType::kServiceManager;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (type_switch == switches::kProcessTypeService) &#123;</span><br><span class="line">      process_type = ProcessType::kService;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      process_type = ProcessType::kEmbedder;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">switch</span> (process_type) &#123;</span><br><span class="line">    <span class="keyword">case</span> ProcessType::kDefault:</span><br><span class="line">      NOTREACHED();</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> ProcessType::kServiceManager:</span><br><span class="line">      exit_code = RunServiceManager(delegate);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> ProcessType::kService:</span><br><span class="line">      CommonSubprocessInit();</span><br><span class="line">      exit_code = RunService(delegate);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> ProcessType::kEmbedder:</span><br><span class="line">      <span class="keyword">if</span> (delegate-&gt;IsEmbedderSubprocess())</span><br><span class="line">        CommonSubprocessInit();</span><br><span class="line">      exit_code = delegate-&gt;RunEmbedderProcess();</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  ......</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (process_type == ProcessType::kEmbedder)</span><br><span class="line">    delegate-&gt;ShutDownEmbedderProcess();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> exit_code;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里截取的代码比较长，也非常重要，我们主要关注这四个部分：</p>
<ul>
<li>根据传入的 <code>delegate</code> 和 <code>command_line</code> 决定进程的类型</li>
<li>运行环境的初始化，比如 <code>CreateATLModuleIfNeeded</code>，<code>SetupCRT</code> 并用 <code>is_initialized</code> 来防止重复执行</li>
<li>通过传入的 <code>delegate</code> 进行程序的初始化操作，<code>delegate-&gt;Initialize(init_params)</code></li>
<li>根据进程类型启动相应的工作</li>
</ul>
<p>这里的 <code>delegate</code> 类型为 <code>service_manager::MainDelegate*</code>，是在 <code>services/service_manager/embedder/main_delegate.h</code> 中定义的抽象类，在这里我们主要关注它的 <code>Initialize</code>、<code>RunEmbedderProcess</code> 和 <code>ShutDownEmbedderProcess</code>，其中 <code>Initialize</code> 为被声明为纯虚函数，<code>RunEmbedderProcess</code> 和 <code>ShutDownEmbedderProcess</code> 又是什么都不做的，代码如下：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// services/service_manager/embedder/main_delegate.h</span></span><br><span class="line"></span><br><span class="line"><span class="function">class <span class="title">COMPONENT_EXPORT</span><span class="params">(SERVICE_MANAGER_EMBEDDER)</span> MainDelegate </span>&#123;</span><br><span class="line"> <span class="keyword">public</span>:</span><br><span class="line">  <span class="comment">// Perform early process initialization. Returns -1 if successful, or the exit</span></span><br><span class="line">  <span class="comment">// code with which the process should be terminated due to initialization</span></span><br><span class="line">  <span class="comment">// failure.</span></span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="keyword">int</span> <span class="title">Initialize</span><span class="params">(<span class="keyword">const</span> InitializeParams&amp; params)</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  ......</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Runs the embedder&#x27;s own main process logic. Called exactly once after a</span></span><br><span class="line">  <span class="comment">// successful call to Initialize(), and only if the Service Manager core does</span></span><br><span class="line">  <span class="comment">// not know what to do otherwise -- i.e., if it is not starting a new Service</span></span><br><span class="line">  <span class="comment">// Manager instance or launching an embedded service.</span></span><br><span class="line">  <span class="comment">//</span></span><br><span class="line">  <span class="comment">// Returns the exit code to use when terminating the process after</span></span><br><span class="line">  <span class="comment">// RunEmbedderProcess() (and then ShutDown()) completes.</span></span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="keyword">int</span> <span class="title">RunEmbedderProcess</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">  ......</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Called just before process exit if RunEmbedderProcess() was called.</span></span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">ShutDownEmbedderProcess</span><span class="params">()</span></span>;</span><br></pre></td></tr></table></figure>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// services/service_manager/embedder/main_delegate.cc</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">MainDelegate::RunEmbedderProcess</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">MainDelegate::ShutDownEmbedderProcess</span><span class="params">()</span> </span>&#123;&#125;</span><br></pre></td></tr></table></figure>
<p>回到 <code>service_manager::Main()</code>，我们看到第一句 <code>MainDelegate* delegate = params.delegate;</code> 中的 <code>params.delegate</code> 就是前面在 <code>content::ContentMain</code> 中构建 <code>main_params</code> 所使用的 <code>content::ContentServiceManagerMainDelegate</code> 对象，因此，上述的三个函数 <code>Initialize</code>、<code>RunEmbedderProcess</code>、<code>ShutDownEmbedderProcess</code> 是由 <code>ContentServiceManagerMainDelegate</code> 来最终实现的，来看代码：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// content\app\content_service_manager_main_delegate.cc</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">ContentServiceManagerMainDelegate::Initialize</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">const</span> InitializeParams&amp; params)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  ......</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> content_main_runner_-&gt;Initialize(content_main_params_);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">......</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">ContentServiceManagerMainDelegate::RunEmbedderProcess</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> content_main_runner_-&gt;Run(start_service_manager_only_);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">......</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ContentServiceManagerMainDelegate::ShutDownEmbedderProcess</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> !defined(OS_ANDROID)</span></span><br><span class="line">  content_main_runner_-&gt;Shutdown();</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在这三个函数的定义中，都使用了 <code>content_main_runner_</code> 这个成员变量来具体执行，它的定义为 <code>std::unique_ptr&lt;ContentMainRunnerImpl&gt;</code>。</p>
<h2 id="6、整个程序的Runner，content-ContentMainRunnerImpl"><a href="#6、整个程序的Runner，content-ContentMainRunnerImpl" class="headerlink" title="6、整个程序的Runner，content::ContentMainRunnerImpl"></a>6、整个程序的Runner，content::ContentMainRunnerImpl</h2><p>这个 <code>content::ContentMainRunnerImpl</code> 是 <code>content::ContentMainRunner</code> 接口的一个实现，先来看接口的声明：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// content\app\content_main_runner_impl.h</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CONTENT_EXPORT</span> <span class="title">ContentMainRunner</span> &#123;</span></span><br><span class="line"> <span class="keyword">public</span>:</span><br><span class="line">  <span class="keyword">virtual</span> ~ContentMainRunner() &#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Create a new ContentMainRunner object.</span></span><br><span class="line">  <span class="function"><span class="keyword">static</span> ContentMainRunner* <span class="title">Create</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Initialize all necessary content state.</span></span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="keyword">int</span> <span class="title">Initialize</span><span class="params">(<span class="keyword">const</span> ContentMainParams&amp; params)</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Perform the default run logic.</span></span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="keyword">int</span> <span class="title">Run</span><span class="params">(<span class="keyword">bool</span> start_service_manager_only)</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Shut down the content state.</span></span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">Shutdown</span><span class="params">()</span> </span>= <span class="number">0</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>再来看实现类的代码：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// content\app\content_main_runner_impl.h</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ContentMainRunnerImpl</span> :</span> <span class="keyword">public</span> ContentMainRunner &#123;</span><br><span class="line"> <span class="keyword">public</span>:</span><br><span class="line">  <span class="function"><span class="keyword">static</span> ContentMainRunnerImpl* <span class="title">Create</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">  ContentMainRunnerImpl();</span><br><span class="line">  ~ContentMainRunnerImpl() <span class="keyword">override</span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">int</span> <span class="title">TerminateForFatalInitializationError</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ContentMainRunner:</span></span><br><span class="line">  <span class="function"><span class="keyword">int</span> <span class="title">Initialize</span><span class="params">(<span class="keyword">const</span> ContentMainParams&amp; params)</span> <span class="keyword">override</span></span>;</span><br><span class="line">  <span class="function"><span class="keyword">int</span> <span class="title">Run</span><span class="params">(<span class="keyword">bool</span> start_service_manager_only)</span> <span class="keyword">override</span></span>;</span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">Shutdown</span><span class="params">()</span> <span class="keyword">override</span></span>;</span><br><span class="line"></span><br><span class="line">  ......</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="7、ContentMainRunner-Initialize-函数"><a href="#7、ContentMainRunner-Initialize-函数" class="headerlink" title="7、ContentMainRunner::Initialize() 函数"></a>7、ContentMainRunner::Initialize() 函数</h2><p>先来看 <code>Initialize</code> 函数：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// content\app\content_main_runner_impl.cc</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">ContentMainRunnerImpl::Initialize</span><span class="params">(<span class="keyword">const</span> ContentMainParams&amp; params)</span> </span>&#123;</span><br><span class="line">  ui_task_ = params.ui_task;</span><br><span class="line">  created_main_parts_closure_ = params.created_main_parts_closure;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(OS_WIN)</span></span><br><span class="line">  sandbox_info_ = *params.sandbox_info;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span>  <span class="comment">// !OS_WIN</span></span></span><br><span class="line"></span><br><span class="line">  ......</span><br><span class="line"></span><br><span class="line">  is_initialized_ = <span class="literal">true</span>;</span><br><span class="line">  delegate_ = params.delegate;</span><br><span class="line"></span><br><span class="line">  ......</span><br><span class="line"></span><br><span class="line">  <span class="keyword">int</span> exit_code = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> (delegate_-&gt;BasicStartupComplete(&amp;exit_code))</span><br><span class="line">    <span class="keyword">return</span> exit_code;</span><br><span class="line">  completed_basic_startup_ = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">  ......</span><br><span class="line"></span><br><span class="line">    delegate_-&gt;PreSandboxStartup();</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(OS_WIN)</span></span><br><span class="line">    <span class="keyword">if</span> (!InitializeSandbox(</span><br><span class="line">            service_manager::SandboxTypeFromCommandLine(command_line),</span><br><span class="line">            params.sandbox_info))</span><br><span class="line">      <span class="keyword">return</span> TerminateForFatalInitializationError();</span><br><span class="line"><span class="meta">#<span class="meta-keyword">elif</span> defined(OS_MACOSX)</span></span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    delegate_-&gt;SandboxInitialized(process_type);</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Return -1 to indicate no early termination.</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>大致看一下，在这个 <code>Initialize</code> 中，主要是根据 <code>command_line</code> 启动了相应的 <code>sandbox service</code>，并在启动前后都触发了 <code>delegate_-&gt;PreSandboxStartup()</code> 和 <code>delegate_-&gt;SandboxInitialized(process_type)</code>，这个 <code>delegate_</code> 来自于传入的 <code>content::ContentMainParams</code> 结构体，这个结构体是在 <code>chrome_main.cc</code> 中调用 <code>content::ContentMain(params)</code> 时所创建，所以这个 <code>delegate_</code> 正是前面所提到的巧妙设计中，继承自 <code>content::ContentMainDelegate</code> 的 <code>ChromeMainDelegate</code> 对象，通过这一系列的调用，<code>content</code> 层就把创建 <code>sandbox service</code> 前后的事件触发了出来，具体实现者只要在 <code>ChromeMainDelegate</code> 中填充这两个时间点要做的事即可。</p>
<h2 id="8、进程入口，ContentMainRunner-Run-函数"><a href="#8、进程入口，ContentMainRunner-Run-函数" class="headerlink" title="8、进程入口，ContentMainRunner::Run() 函数"></a>8、进程入口，ContentMainRunner::Run() 函数</h2><p>再来看 <code>Run</code> 函数：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// // content\app\content_main_runner_impl.cc</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">ContentMainRunnerImpl::Run</span><span class="params">(<span class="keyword">bool</span> start_service_manager_only)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  ......</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> base::CommandLine&amp; command_line =</span><br><span class="line">      *base::CommandLine::ForCurrentProcess();</span><br><span class="line">  <span class="built_in">std</span>::<span class="built_in">string</span> process_type =</span><br><span class="line">      command_line.GetSwitchValueASCII(switches::kProcessType);</span><br><span class="line"></span><br><span class="line">  ......</span><br><span class="line"></span><br><span class="line">  <span class="function">MainFunctionParams <span class="title">main_params</span><span class="params">(command_line)</span></span>;</span><br><span class="line">  main_params.ui_task = ui_task_;</span><br><span class="line">  main_params.created_main_parts_closure = created_main_parts_closure_;</span><br><span class="line"></span><br><span class="line">  ......</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (process_type.empty())</span><br><span class="line">    <span class="keyword">return</span> RunServiceManager(main_params, start_service_manager_only);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> RunOtherNamedProcessTypeMain(process_type, main_params, delegate_);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>此处先判断 <code>process_type</code> 是否为空，为空则代表当前执行的是默认进程（一般情况下为 <code>Browser</code> 进程），则调用 <code>RunServiceManager()</code>，否则调用 <code>RunOtherNamedProcessTypeMain</code> 根据<code>process_type</code> 来执行相应的进程。先来看 <code>RunServiceManager</code>：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// content\app\content_main_runner_impl.cc</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">ContentMainRunnerImpl::RunServiceManager</span><span class="params">(MainFunctionParams&amp; main_params,</span></span></span><br><span class="line"><span class="function"><span class="params">                                             <span class="keyword">bool</span> start_service_manager_only)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  ......</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!service_manager_context_) &#123;</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">    delegate_-&gt;PreCreateMainMessageLoop();</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line">    </span><br><span class="line">    delegate_-&gt;PostEarlyInitialization(main_params.ui_task != <span class="literal">nullptr</span>);</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line">    </span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (should_start_service_manager_only)</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">  is_browser_main_loop_started_ = <span class="literal">true</span>;</span><br><span class="line">  startup_data_ = <span class="built_in">std</span>::make_unique&lt;StartupDataImpl&gt;();</span><br><span class="line">  startup_data_-&gt;thread = <span class="built_in">std</span>::move(service_manager_thread_);</span><br><span class="line">  startup_data_-&gt;service_manager_context = service_manager_context_.get();</span><br><span class="line">  main_params.startup_data = startup_data_.get();</span><br><span class="line">  <span class="keyword">return</span> RunBrowserProcessMain(main_params, delegate_);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>同样，这里通过 <code>delegate_</code> 做了一些操作之后，最后调用了 <code>RunBrowserProcessMain()</code> 函数，内容如下：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// content\app\content_main_runner_impl.cc</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">RunBrowserProcessMain</span><span class="params">(<span class="keyword">const</span> MainFunctionParams&amp; main_function_params,</span></span></span><br><span class="line"><span class="function"><span class="params">                          ContentMainDelegate* delegate)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">int</span> exit_code = delegate-&gt;RunProcess(<span class="string">&quot;&quot;</span>, main_function_params);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(OS_ANDROID)</span></span><br><span class="line">  <span class="comment">// In Android&#x27;s browser process, the negative exit code doesn&#x27;t mean the</span></span><br><span class="line">  <span class="comment">// default behavior should be used as the UI message loop is managed by</span></span><br><span class="line">  <span class="comment">// the Java and the browser process&#x27;s default behavior is always</span></span><br><span class="line">  <span class="comment">// overridden.</span></span><br><span class="line">  <span class="keyword">return</span> exit_code;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">  <span class="keyword">if</span> (exit_code &gt;= <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">return</span> exit_code;</span><br><span class="line">  <span class="keyword">return</span> BrowserMain(main_function_params);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>非常简单明了，首先通过 <code>delegate-&gt;RunProcess</code> 把执行默认进程的优先权交由 <code>Embedder</code> 层，如果 <code>Embedder</code> 层成功执行了进程并最终返回了成功标志（<code>exit_code &gt;= 0</code>），那么就退出函数；如果 <code>Embedder</code> 层对默认进程没有定义，就继续执行 <code>content::BrowserMain</code>，由此，<code>Browser</code> 进程开始执行。</p>
<p>再来看 <code>RunOtherNamedProcessTypeMain</code> 函数：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// content\app\content_main_runner_impl.cc</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">RunOtherNamedProcessTypeMain</span><span class="params">(<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span>&amp; process_type,</span></span></span><br><span class="line"><span class="function"><span class="params">                                 <span class="keyword">const</span> MainFunctionParams&amp; main_function_params,</span></span></span><br><span class="line"><span class="function"><span class="params">                                 ContentMainDelegate* delegate)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">const</span> MainFunction kMainFunctions[] = &#123;</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line">    </span><br><span class="line">    &#123;switches::kUtilityProcess, UtilityMain&#125;,</span><br><span class="line">    &#123;switches::kRendererProcess, RendererMain&#125;,</span><br><span class="line">    &#123;switches::kGpuProcess, GpuMain&#125;,</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; base::size(kMainFunctions); ++i) &#123;</span><br><span class="line">    <span class="keyword">if</span> (process_type == kMainFunctions[i].name) &#123;</span><br><span class="line">      <span class="keyword">int</span> exit_code = delegate-&gt;RunProcess(process_type, main_function_params);</span><br><span class="line">      <span class="keyword">if</span> (exit_code &gt;= <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> exit_code;</span><br><span class="line">      <span class="keyword">return</span> kMainFunctions[i].function(main_function_params);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  ......</span><br><span class="line"></span><br><span class="line">  <span class="comment">// If it&#x27;s a process we don&#x27;t know about, the embedder should know.</span></span><br><span class="line">  <span class="keyword">return</span> delegate-&gt;RunProcess(process_type, main_function_params);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>先建立了一个进程类型和入口函数指针的对应数组，再根据进程类型去具体执行，执行的过程与 <code>Browser</code> 进程一样，先通过 <code>delegate-&gt;RunProcess</code> 交由 <code>Embedder</code> 层处理，如果未处理再调用默认的进程入口函数，可以看到分别提供了 <code>UtilityMain</code>、<code>RendererMain</code>、<code>GpuMain</code> 这三个进程的入口，其中 <code>RendererMain</code> 则是我们关注的 <code>Renderer</code> 进程的入口函数，<code>Renderer</code> 进程从此处开始执行。最后一句，如果进程类型不在以上范围内，则交由 <code>Embedder</code> 去处理。</p>
<h2 id="9、程序结束"><a href="#9、程序结束" class="headerlink" title="9、程序结束"></a>9、程序结束</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ContentMainRunnerImpl::Shutdown</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  DCHECK(is_initialized_);</span><br><span class="line">  DCHECK(!is_shutdown_);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (completed_basic_startup_) &#123;</span><br><span class="line">    <span class="keyword">const</span> base::CommandLine&amp; command_line =</span><br><span class="line">        *base::CommandLine::ForCurrentProcess();</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">string</span> process_type =</span><br><span class="line">        command_line.GetSwitchValueASCII(switches::kProcessType);</span><br><span class="line"></span><br><span class="line">    delegate_-&gt;ProcessExiting(process_type);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> !defined(CHROME_MULTIPLE_DLL_CHILD)</span></span><br><span class="line">  <span class="comment">// The BrowserTaskExecutor needs to be destroyed before |exit_manager_|.</span></span><br><span class="line">  BrowserTaskExecutor::Shutdown();</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span>  <span class="comment">// !defined(CHROME_MULTIPLE_DLL_CHILD)</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(OS_WIN)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> _CRTDBG_MAP_ALLOC</span></span><br><span class="line">  _CrtDumpMemoryLeaks();</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span>  <span class="comment">// _CRTDBG_MAP_ALLOC</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span>  <span class="comment">// OS_WIN</span></span></span><br><span class="line"></span><br><span class="line">  exit_manager_.reset(<span class="literal">nullptr</span>);</span><br><span class="line"></span><br><span class="line">  delegate_ = <span class="literal">nullptr</span>;</span><br><span class="line">  is_shutdown_ = <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>首先通过 <code>delegate_-&gt;ProcessExiting(process_type)</code> 通知 <code>Embedder</code> 层处理，然后做了一些善后释放的工作，最后将 <code>is_shutdown_</code> 标记置为 <code>true</code>。</p>
<h2 id="10、总结"><a href="#10、总结" class="headerlink" title="10、总结"></a>10、总结</h2><img src="/2019/04/01/chromium-startup/startup.png" class="" title="启动相关类图">
<p>前面分析了这么多，其实结合类图来看一下还是很简单明了的，主要起到作用的就是图中标红的三个，<code>service_manager::Main</code> 通过 <code>content::ContentServiceManagerMainDelegate</code> 的实例调用了 <code>content::ContentMainRunnerImpl</code> 实例中的 <code>Initialize()</code>、<code>Run()</code>、<code>Shutdown()</code> 函数，而在这个Runner中，又通过 <code>content::ContentMainDelegate</code> 接口指针调用到了由 <code>Embedder</code> 层创建的 <code>ChromeMainDelegate</code> 实例中的函数，由此完成了程序的启动以及 <code>Content</code> 层对 <code>Embedder</code> 的交互。</p>

      

      
        
    </div>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2020/04/02/about-git/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          Git使用笔记
        
      </div>
    </a>
  
  
    <a href="/2019/04/01/centos6-7-oracle/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">CentOS 6.7 安装 Oracle 11g2</div>
    </a>
  
</nav>

  
</article>


</section>
        <aside id="sidebar">
  <nav class="menus">
  	<ul>
  		<li><a href="/"><i class="icon icon-home"></i></a></li>
  		
			<li><a href="/archives"><i class="icon icon-fenlei"></i></a></li>
  		
  		
			<li><a href="/tags"><i class="icon icon-tag"></i></a></li>
  		
  		
  			<li><a href="https://github.com/singlesword" target="_blank"><i class="icon icon-github"></i></a></li>
  		
  	</ul>
  </nav>
  <a id="go-top" href="#"><i class="icon icon-up"></i></a>
</aside>

      </div>
      <footer id="footer">
  
	<div id="footer-info" class="inner">
	  &copy; 2021 YangXC 
	  - Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
	  - Theme <a href="https://github.com/hejianxian/hexo-theme-jane/" target="_blank">Jane</a>
	</div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
    <a href="/tags" class="mobile-nav-link">Tag</a>
  
    <a target="_blank" rel="noopener" href="https://github.com/singlesword" class="mobile-nav-link">Github</a>
  
</nav>
    

<script src="//cdn.bootcss.com/jquery/2.0.3/jquery.min.js"></script>


  
<link rel="stylesheet" href="/fancybox/jquery.fancybox.css">

  
<script src="/fancybox/jquery.fancybox.pack.js"></script>




<script src="/js/script.js"></script>


  </div>
</body>
</html>